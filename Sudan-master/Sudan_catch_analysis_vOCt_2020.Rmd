---
title: "Sudan_catch_analysis"
author: "Erik Olsen"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  html_document: default
  pdf_document: default
---
# Analysis of Sudan survey data 2012 - 2013

This R-markdown document contains all r-code used to carry out the analysis for the paper on fish catch rates and species densities (species richness) along the Red Sea coast of Sudan. The analysis is based on three surveys: November 2012, May 2013 and November 2013. 

Here the analysis is structured around the 7 management regions of the Sudanese Red Sea coast as follows:

- Present the region: Bathymetric map
- Sampling locations
- Table of effort (diffent gear types per management areas.)
- Depth distribution of traps by survey and area
- Catch CPUE by area and survey
- Catch CPUE distribution by gear, by species groups (should perhaps do the same for trophic groups)
- CPUE by trophic group pr area and survey
- CPUE by depth and tropich group and survey
- Biodiversity /species densities
- Statistical analysis
  - test of normality shows that we need to use non-parametric and zero-adjusted approaches. 
  - CPUE as a function of area, depth, survey, gear (Zero-adjusted model)

All code and data are stored on GitHub

## Libraries, data etc. 
### Libraries, dependencies and functions
```{r libraries and dependencies, echo=FALSE, warning=FALSE, message=FALSE}
library(reshape2)
library(maps)
library(mapdata)
library(ggplot2)
library(RColorBrewer)
library(sp)
library(rgdal)
library(rgeos)
# plyr mus be loaded befor dplyr for both to work
library(plyr) 
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(maptools)
library(marmap)
library(classInt)
library(colorspace)
library("formattable")
library("PMCMR")
library(FD)
library("gamlss")
library(patchwork)
```


```{r functions, echo=FALSE}

capwords <- function(s, strict = FALSE) {
  cap <- function(s) paste(toupper(substring(s, 1, 1)),
                           {s <- substring(s, 2); if(strict) tolower(s) else s},
                           sep = "", collapse = " " )
  sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}
```


### Load and manipulate data
Reading catch, station and traits data. 

Neither station data, nor catch data has a complete depth record, but by combining depth para from each we can get a complete depth parameter for all stations. 
```{r load data, echo=FALSE}
#' Catch data
catch<-read.csv2("catch.csv")
catch$survey<-as.factor(catch$survey)
catch$CPUEw<-catch$weight/catch$Fhrs
catch$CPUEn<-catch$number/catch$Fhrs

#' Station
station <- read.csv2("stations.csv")

#' add depth to catch from station
catch$d1<- station$geardepthstart[match(catch$ss, station$ss)]  
catch$depth <- apply(X=cbind(catch$bdep, catch$d1), MARGIN=1, FUN=max, na.rm=TRUE)

#' Add Month. Year survey column
catch$survey_m<-as.character(catch$survey)
catch$survey_m<-replace(catch$survey_m, grep("2012901", catch$survey_m), "Survey 1: Nov. 2012")
catch$survey_m<-replace(catch$survey_m, grep("2013002", catch$survey_m), "Survey 2: May 2013")
catch$survey_m<-replace(catch$survey_m, grep("2013005", catch$survey_m), "Survey 3: Nov. 2013")

#'Traits
traits <- read.csv2("traits_noNa.csv")
```


### Sudan map and management areas
Loads the map data for Sudan, loads the management areas from shape-file etc. 
```{r map data, echo=FALSE, warning=FALSE}
#' SUDAN MAP DATA
world<- map_data("worldHires", c("Sudan", "Ethiopia")) 
world$survey_m<-c("Survey 1: Nov. 2012")
world2<-world
world2$survey_m<-c("Survey 2: May 2013")
world3<-world
world3$survey_m<-c("Survey 3: Nov. 2013")
world<-rbind(world, world2, world3)

#'  SPATIAL POLYGONS FOR MANAGEMENT AREAS
#setwd("/Users/eriko/Documents/GitHub/Sudan2019/Sudan-master")
setwd("/Users/eriko/GitHub/Sudan2019/Sudan-master")
setwd("./sudan_management_areas")
ManageAreas<-readOGR(dsn = ".", "sudan_regions")
setwd("..")

#' setting correct projection LAT LON
ManageAreas <- spTransform(ManageAreas, CRS("+proj=longlat +ellps=GRS80"))

#' Create  area map with numbers for each region
ManageAreas.f<-fortify(ManageAreas, region="id") #creates X - Y points of the polygons
cnames <- aggregate(cbind(long, lat) ~ id, data=ManageAreas.f, FUN=function(x)mean(range(x)))
cnames$id<-c(1:7)

#' position of Port Sudan
ps<-rbind(data.frame(x=37.21709967,y=19.600512, group=1, survey_m=c("Survey 1: Nov. 2012")),data.frame(x=37.21709967,y=19.600512, group=1, survey_m=c("Survey 2: May 2013") ),data.frame(x=37.21709967,y=19.600512, group=1, survey_m=c("Survey 3: Nov. 2013") ))
```

### Allocating catch positions to management areas
Adds 'Area' to each line in the catch table. 
```{r catch pos to mngmt areas, echo=FALSE}
#' Create spatial.points data base from catch
catch.points<- SpatialPoints(catch[8:9])
proj4string(catch.points) <- proj4string(ManageAreas)
catch.areas<-over(catch.points, ManageAreas)

#' fix area number to area name
alist<-data.frame(name=levels(as.factor(catch.areas$name)), id=c(7,3,2,1,4,5,6))
catch <- cbind(catch, catch.areas[2])
catch$id <- alist$id[match(catch$name, alist$name)]  

#' allocate management areas to catches outside of polygons (choose nearest polygon)
naarea <- catch[is.na(catch$id),]
naarea$id <- naarea$Area
naarea$name[1] <- c("Arakiai")
naarea$name[2:8] <- c("Suakin Archipelago")
naarea$name[9:16] <- c("Donganab")
catch<- rbind(subset(catch, id>=1), naarea) 

#' Change family names to Upper & Lower case
#catch$FamGroup2 <- paste(toupper(substr(catch$FamGroup, 1, 1)), tolower(substr(catch$FamGroup, 2, 20)), sep="")
#catch$FamGroup2 <- as.factor(catch$FamGroup2)
```




### Modifying dataset and creating one dataset for CPUE analysis and another for traits
Of the catch data, 12 fish registrations lack weight, (i.e. this was forgotten entered into the database during the survey). These registrations, would if included lead to 12 more registrations of CPUE = 0. 
```{r nocatch dataset, echo=FALSE}
#' Keep a copy of original 'catch'
catch.unmod <- catch

#' remove Hand Line stations with too short time <1 hr, and too long time >8 hrs
# hist((subset(catch, gear=="HL" & Fhrs>0))$Fhrs, breaks =20) # get an idea of the spread in fishing time
catch <- rbind(subset(catch, gear!="HL"), subset(catch, gear=="HL" & Fhrs>1 & Fhrs<8))

#' remove 14 records where weight of fish has not been recorded
names <- row.names(subset(catch, weight==0 & number>0))
catch.cpue <- subset(catch, !(rownames(catch) %in% names))


#' selecting only stations with catch & removes stations shorter than 1 hour - two handline stations with fishing time recorded as 5min, that we know is wrong, but we don't have the correct time. 
catch1<-subset(catch, Sci_name!="No catch" & Sci_name!="NO CATCH") 

```

### Adding traits to 'catch' data set (without 0-catch stations)
Some more data wrangling that adds the traits from the traits table to the catch data, using only the station with catches (there are no traits for 'NOCATCH' species). 

Also, only select traps, gillnets and handlines as these were the only gear with sufficient numbers and consistent use to be analyzed. 

Lastly adds number of gear deployed at each station to each line. 
```{r add traits,  echo=FALSE}
catch.traits <- catch1
catch.traits$MaxLength<- traits$MaxLength[match(catch1$Sci_name, traits$x1)]  
catch.traits$TrophicLevel<- traits$Trophic.Level[match(catch1$Sci_name, traits$x1)]  
catch.traits$TrophicGroup<- traits$Trophic.group[match(catch1$Sci_name, traits$x1)] 
catch.traits$WaterCol<- traits$Water.column[match(catch1$Sci_name, traits$x1)] 
catch.traits$DielActivity<- traits$Diel.Activity[match(catch1$Sci_name, traits$x1)] 
catch.traits$Habitat<- traits$Habitat[match(catch1$Sci_name, traits$x1)] 
catch.traits$Gregariousness<- traits$Gregariousness[match(catch1$Sci_name, traits$x1)] 
catch.traits$Sci_name_New<- traits$x2[match(catch1$Sci_name, traits$x1)] 
catch.traits$Gregariousness[catch.traits$Sci_name=="Lethrinus mahsena"] <- c(2)
catch.traits$Gregariousness[catch.traits$Sci_name=="Sphyraena jello"] <- c(3)
catch.traits$Gregariousness[catch.traits$Sci_name=="Thunnus albacares"] <- c(3)
catch.traits$Gregariousness[catch.traits$Gregariousness=="#N/A"] <- NA

catch.traits$Gregariousness <- droplevels(as.factor(catch.traits$Gregariousness))

#' collate Trophic groups and give shorter names
tn<-data.frame(TCat=levels(as.factor(catch.traits$TrophicGroup)), short=c("Invert.", "Herb.", "Coral.", "Carni.", "Plankt.", "Herb."))
catch.traits$TGShort <- tn$short[match(catch.traits$TrophicGroup, tn$TCat)]

#' select only Traps, Gillnet and Handline
catch.traits <- subset(catch.traits, gear=="HL" | gear=="TB" | gear=="GN")
catch.traits$ss1 <- as.factor(catch.traits$ss)

#' add number of stations in that area to each line
c3 <- catch.traits %>% dplyr::group_by(ss1) %>% dplyr::summarise( first(depth), first(gear), first(id), first(survey), first(survey_m))
colnames(c3) <- c("ss", "depth", "gear", "id", "survey", "survey_m")
n.area <- c3 %>% dplyr::group_by(id) %>% dplyr::summarise(n_distinct(ss))
colnames(n.area) <- c("id", "nos")

catch.traits$NArea <- n.area$nos[match(catch.traits$id, n.area$id)]
```



## Bathymetric map of Sudan
Fig. 1 in MS

A nice, bathymetric map of Sudan with management areas overlaid. 

Currently fonts and colours are adjusted for use on the ICES ASC 2019 poster, removing the bathy-contour lines (se 'lwd' to 0), and varying the colours of management area text to white for areas 1-4. 

```{r bathymap sudan, echo=FALSE}
sudan<-readGEBCO.bathy("./sudan_bathymetry/sudan.nc")
blues <- colorRampPalette(c("midnightblue", "deepskyblue3", "deepskyblue1", "cadetblue3", "cadetblue1", "darkseagreen1", "white"))

tiff(file="./figs/Fig1_sudan_bathy_map.tiff", width=1900, height=3000, res=400, pointsize=10, compression=c("none"))

plot(sudan, land = TRUE, n = 10, image = TRUE,
     bpal = list(c(min(sudan), -20, "midnightblue", "blue", "lightblue3"),
                 c(-20, 0, "lightblue1", "aquamarine1"),
                 c(0, max(sudan), "gray90", "gray50")), 
     deep = c(-3000, -500, 0),
     shallow = c(-500, -10, 0),
     step = c(500, 200, 0),
     lwd = c(0, 0, 1), lty = c(1, 1, 1),
     col = c("lightgrey", "gray15", "black"),
     drawlabel = c(TRUE, TRUE, TRUE))

scaleBathy(sudan, deg=0.47 ,x="bottomleft", inset=5)

points(37.21709967, 19.600512, pch=19)
points(37.33333, 19.1, pch=19)

text(37.21709967, 19.600512,"Port \nSudan", adj=c(1.2,0), font=2)
text(37.333333, 19.1,"Suakin", adj=c(1.2,0), font=1)
text(37.4, 21.7, "1. Marsas \nnorth of \nDungonab", cex=0.9, font=2, col="white")
text(37.653, 20.92, "2. Dungonab", cex=0.9, font=2, col="white")
text(37.6, 20.3, "3. Arakiai", cex=0.9, font=2, col="white")
text(37.615, 19.95, "4. Port \nSudan", cex=0.9, font=2, col="white")
text(37.6, 18.9, "5. Suakin", cex=0.9, font=2)
text(38, 19.2, "6. Suakin \narchipelago", cex=0.9, font=2)
text(38.3, 18.5, "7. Agig", cex=0.9, font=2)

MApoints<-data.frame(lon=c(37.2, 37.4, 37.38, 37.4, 37.6, 37.9, 38.3), lat=c(21.7, 20.92, 20.3, 19.9, 19, 19.3, 18.5), area=c(1,2,3,4,5,6,7))

ms<-c(1,3,4,5,6,7,8)
for (i in 1:7){
  ma<-subset(ManageAreas.f, id==ms[i])
  polygon(ma$long, ma$lat, lwd=2)  
}

dev.off()
```

![](./figs/sudan_bathy_map.tiff)


## Stations plotted on maps, pr survey
Faceted map plotting position of all catch stations for each of the three surveys. 
```{r station map, echo=FALSE}
MApoints<-data.frame(lon=c(37.2, 37.53, 37.5, 37.4, 37.3, 37.9, 38.2), lat=c(21.7, 20.92, 20.3, 19.9, 19, 19.3, 18.5), area=c(1,2,3,4,5,6,7))

sudan.map<-ggplot(catch, aes(x=lon, y=lat, group=survey_m)) + geom_point(shape="+", size=6, aes(group=survey_m, colour= survey_m)) + facet_wrap(~survey_m, ncol=3) + geom_path(data=ManageAreas.f,colour="dodgerblue3", aes(x=long, y=lat, group=id)) + geom_polygon(data=world, colour="gray35", fill="gray85", aes(x=long, y=lat, group=survey_m)) +  coord_cartesian(xlim = c(36.5, 39), ylim=c(17.7, 22.5)) + theme_classic() + geom_point(data=ps, size=2, colour="gray35", aes(x=x, y=y)) + geom_text(data=ps, label="PZU", size=3,  hjust=1, vjust=-1.2,  aes(x=x, y=y, group=survey_m)) +geom_text(data=MApoints, aes(x=lon, y=lat, group=area, label=area)) +scale_colour_brewer(type = "seq", palette = "Dark2", name="Survey month & year", labels=c("Nov. 2012", "May. 2013", "Nov. 2013")) + theme(legend.position="none")
sudan.map

ggsave("./figs/Fig2_station_map.tiff")
```


## Station information
### Station table
Table describing the sampling effort in each area pr survey, number of different gear types, max, min and average depth, number of traps with / without catches. 
```{r station table, echo=FALSE}
#' TABLE OF SAMPLING EFFORT PR. MANAGEMENT AREA
#' (new for resubmission to PlosOne)
#' --------------------------------------------

s <- unique(catch.unmod$survey)
a <- as.factor(1:7)
ay_info <- data.frame(survey=integer(), id=integer(), Ntraps=integer(), Nhl=integer(), NGn=integer(), TBhrs=double(), HLhrs=double(), GNhrs=double(), DepthAvg=double(), DepthSD=double(),DepthMax=double(), DepthMin=double()) 
cn <- colnames(ay_info)
# depth for TB only (GN are at the surface, and HL not measured)

for (i in 1:length(s)) { 
  y <- subset(catch.unmod, survey==s[i])
  for (j in 1: length(a)){
    ay_1 <- data.frame(survey=integer(), id=integer(), Ntraps=integer(), Nhl=integer(), NGn=integer(), TBhrs=double(), HLhrs=double(), GNhrs=double(), DepthAvg=double(), DepthSD=double(), DepthMax=double(), DepthMin=double())
    ya <- subset(y, id==a[j])
    ay_1 <- rbind(ay_1, c(
      as.integer(as.character(ya$survey[1])), 
      as.integer(as.character(ya$id[1])), 
      length(unique(subset(ya, gear=="TB")$station)),  
      length(unique(subset(ya, gear=="HL")$station)), 
      length(unique(subset(ya, gear=="GN")$station)), 
      sum(subset(ya, gear=="TB")[!duplicated(ya$station),]$Fhrs, na.rm=TRUE),  
      sum(subset(ya, gear=="HL")[!duplicated(ya$station),]$Fhrs, na.rm=TRUE), 
      sum(subset(ya, gear=="GN")[!duplicated(ya$station),]$Fhrs, na.rm=TRUE), 
      mean(subset(ya, gear=="TB")[!duplicated(ya$station),]$depth, na.rm=TRUE), 
      sd(subset(ya, gear=="TB")[!duplicated(ya$station),]$depth, na.rm=TRUE),
      max(subset(ya, gear=="TB")$depth, na.rm=TRUE), 
      min(subset(ya, gear=="TB")$depth, na.rm=TRUE)    ))
    colnames(ay_1) <- cn
    ay_info <- rbind(ay_info, ay_1)
    colnames(ay_info) <- cn
  }
}

formattable(ay_info)

write.csv2(ay_info, "./figs/Area_Station_table.csv")
```

#### Species table
Number of fish (organized by family and species) caught by Gillnet or Traps for each survey, and in total across all surveys and gears. 

* (new table for revision 2020) *
```{r species tabel, echo=FALSE}

species.table <- subset(catch, Sci_name!="NO CATCH" & Sci_name!="No catch" & gear=="TB" | gear =="GN") %>% dplyr::group_by(Fam_name, Sci_name, survey, gear) %>% dplyr::summarise(No.individ=sum(as.integer(number)))

species.table <- spread(species.table, gear, No.individ)

spt <- species.table[,2:5] %>%
  gather(variable, value, -(Sci_name:survey)) %>%
  unite(temp, survey, variable) %>%
  spread(temp, value)  %>%
  replace(is.na(.), 0) %>%
  rowwise() %>%
  #mutate(sum = rowSums(.[2:7]))
  dplyr::mutate(sum = sum(c_across("2012901_GN":"2013005_TB")))

spt$fam_name <- species.table$Fam_name[match(spt$Sci_name, species.table$Sci_name)] 
 
spt[,c(9,1:8)]%>%
  kable(format = "html", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 8)

write.csv2(spt, "./figs/species_catch_table.csv")
```


***

### Number of set traps per depth
Violin plot of depths at wich traps were set. I prefer this visualization of depth ranges of the traps, rather than a (boring) table. 
```{r traps per depth, echo=FALSE}

# New facet label names for survey variable
#survey.labs <- c("Nov.2012", "May.2013", "Nov.2013")
#names(survey.labs) <- c("Survey 1: Nov. 2012", "Survey 2: May 2013",  "Survey 3: Nov. 2013")

c2 <- catch %>% dplyr::group_by(ss) %>% dplyr::summarise(first(depth), first(gear), first(id), first(survey), first(survey_m))
colnames(c2) <- c("ss", "depth", "gear", "id", "survey", "survey_m")
c2$survey_m <- as.factor(c2$survey_m)



# function for number of observations 
give.n <- function(x){
  return(c(y = median(x)*0.7, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}

dp <- ggplot(subset(c2, gear=="TB" & depth!=0), aes(as.factor(id), depth))

#dp <- dp +  geom_violin(scale="width", aes(fill=as.factor(id)), draw_quantiles = c(0.5)) + scale_y_reverse() +stat_summary(fun.data = give.n, geom = "text", fun.y = median) + labs(x="Management areas", y="Trap set depth (m)") + scale_fill_manual(name="Management area",values=sequential_hcl(n = 7, h = c(0, -100), c = c(80, NA, 40), l = c(53, 75), power = c(1, 1), rev = TRUE, register = ), guide=FALSE ) +theme_bw()  +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

dp <- dp +  geom_boxplot(scale="width", aes(), draw_quantiles = c(0.5)) + scale_y_reverse() +stat_summary(fun.data = give.n, geom = "text", fun.y = median, vjust=-1.7) + labs(x="Management areas", y="Trap set depth (m)")  +theme_bw()  +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

dp

#tiff(file="./figs/trap_area_depth.tiff", width=3000, height=1500, res=400, pointsize=10, compression=c("none"))
#dp
#dev.off()
```

####Test differneces in depths in each area between years and between areas

```{r  test trap depth, echo=FALSE}

c3 <- subset(catch, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))

#' test for normality
shapiro.test(c3$depth)

# significan difference, e.g null-hypothesis that data are normally distributed is rejected

#' Q-Q plots
ggplot(data = c3, mapping = aes(sample = depth,  fill = factor(id))) + qqplotr::stat_qq_band() + qqplotr::stat_qq_line() + qqplotr::stat_qq_point(size=0.2) + facet_wrap(~ id, scales="free") +  labs(x = "depth predicted", y = "depth Observed") + ggtitle("Q-Q plots depth")

#CONCLUSION: Depth is NOT normally distributed, so can use ANOVA for analysis of variance

# Use non-parametric Kruskal-Wallis test

#' 1 - test for difference between areas
kruskal.test(c3$depth, c3$id)
#significant difference

#' Post-Hoc tests of Kruskal - Wallis results
#library("PMCMR", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
PMCMR::posthoc.kruskal.nemenyi.test(c3$depth, c3$id, "Chisq")

#' significant difference between areas 1:5, 2:5, 5:6, 5:7


#' 2 - test for differences between areas and surveys
surv <- levels(as.factor(c3$survey))
for (i in 1:length(surv)){ 
  ci <- subset(c3, survey==surv[i])
  print(surv[i])
  print(kruskal.test(ci$depth, ci$id))
  print(PMCMR::posthoc.kruskal.nemenyi.test(ci$depth, ci$id, "Chisq"))
}

# significant differences between
# Nov. 2012 - between 1:5, 2:5, 5:6, 5:7 
# May 2013 - between 2:5
# Nov 2013 - Not significan K-W test and no significan pairwise differences. 

```
Depth data were not normally distributed and hence the difference in depth could only be analyzed using non-parametric Kruskal - Wallis rank sum test. 

Of the 63 survey - area comparisons, depth distributions were different between areas as follows:
Nov.2012 survey:
1:5, 2:5, 5:6 and 5:7  
May 2013 survey:
2:5

No significant differences for the Nov. 2013 survey



##### GAM model of trap depths
Fits a GAM model (using GAMLSS package) to the depth with area as explanatory variable and survey as a random factor. Use 'chooseDIst' function to test which distribution on the positive real line best fit the data. 
```{r GAM depths random survey, echo=FALSE}

# using the function chooseDist()
# fitting normal distribution model
#m1 <- gamlss(depth~factor(id)+factor(survey),  family=NO, data=c3)
m1 <- gamlss(depth~factor(id)+random(factor(survey)),  family=NO, data=c3)

# choose a distribution on the positive real line 
t1 <- chooseDist(m1, type="realplus")

# the GAIC's
t1

# only 'exGAUS' and 'PARETO2' and 'PARETO2o' were able to run, with 'exGAUS' giving the best GAIG fit. 

# ordering according to  BIC
getOrder(t1,3)

#updating the model with the best distribution 'EXGAUS'
fm<-update(m1, family=names(getOrder(t1,3)[1]))
summary(fm)
fm
AIC(fm)
drop1(fm)
#plot(fm)
# Significant factors: areas 3, 4, 5, and 6 

histDist(depth,family="exGAUS", ymax=0.05, nbins=20, data=c3)

```

The GAMLSSS model picked 'exGAUS' as the best distribution to use in the model, which seems sensible from plotting the model over historgram of the depth. 

Using the 'exGAUS' model areas 3, 4, 5 and 6 come out as significant factors, meaning the depth in these areas are significantly different from depths in other areas. The 'drop1' function showed that surveys as a random effect were a significant factor in the model. 

##### Combination of GAMLSS model and Kruskal - Wallis
The GAMLSS model shows that there are signicant effects of area 3, 4, 5, and 6 on the depth distribution, and the K-W test shows significant differences for the Nov. 2012 survey between area 1:5, 2:5, 5:6, 5:7 and for the May 2013 survey for areas 2:4, which is in corrspondence with the GAM results. 


*** 

### Duration of trap sets 

#### Mean, min & max hrs. of fishing
```{r hrs of fishing, echo=FALSE}
subset(catch, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), fhrs=first(Fhrs)) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise( maxhrs=max(fhrs), minhrs=min(fhrs), meanhrs=mean(fhrs)) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)

#overall mean Fhrs
summary(subset(catch, gear=="TB") %>% 
  group_by(ss) %>% 
  dplyr::summarise(id=first(id), fhrs=first(Fhrs)))

```


### Fishing hours (traps) by survey and area
Boxplot of median with mean values plotted as red circle. 
```{r duration traps, echo=FALSE}

c3 <- subset(catch, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
c3$survey_m <- as.factor(c3$survey_m)


duration.plot <- ggplot(c3, aes(as.factor(id), Fhrs))

duration.plot <-  duration.plot +  geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=20, size=4, color="red", fill="red") + labs(x="Management areas", y="Hours fishing (traps)")  +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May.2013",
      "Survey 3: Nov. 2013" = "Nov.2013")))

duration.plot
#a1 <- subset(c3, id==1)
#ggplot(a1, aes(as.factor(id), Fhrs)) + geom_boxplot()+facet_wrap(~as.factor(survey_m))

#by(a1$Fhrs, a1$survey, summary)
```
The average trap soak-time (fishing hours) across all surveys and areas was 17.984 hrs with a median of 16.15, but the November 2012 survey had more varied and higher soak times than the May 2013 and Nov. 2013. 

#### Test differences in soak times (traps) K-W test
```{r  test Fhrs traps, echo=FALSE}
#' test for normality
shapiro.test(c3$Fhrs)

#' Q-Q plots
ggplot(data = c3, mapping = aes(sample = Fhrs,  fill = factor(id))) + qqplotr::stat_qq_band() + qqplotr::stat_qq_line() + qqplotr::stat_qq_point(size=0.2) + facet_wrap(~ id, scales="free") +  labs(x = "Fhrs predicted", y = "Fhrs Observed") + ggtitle("Q-Q plots depth")

#CONCLUSION: Fishing hours (soak time) is NOT normally distributed, so can use ANOVA for analysis of variance

# Use non-parametric Kruskal-Wallis test

#' 1 - test for difference between areas
kruskal.test(c3$Fhrs, c3$id)
#significant difference

#' Post-Hoc tests of Kruskal - Wallis results
#library("PMCMR", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
PMCMR::posthoc.kruskal.nemenyi.test(c3$Fhrs, c3$id, "Chisq")

#' significant difference between areas 7:1, 7:2, 6:2, 7:4, 6:4, 7:5, 


#' 2 - test for differences between areas and surveys
surv <- levels(as.factor(c3$survey))
for (i in 1:length(surv)){ 
  ci <- subset(c3, survey==surv[i])
  print(surv[i])
  print(kruskal.test(ci$Fhrs, ci$id))
  print(PMCMR::posthoc.kruskal.nemenyi.test(ci$Fhrs, ci$id, "Chisq"))
}

# Significant differences between:
# Nov 2012- between: 1:7, 7:2, 6:2, 7:3, , 7:4, 6:4, 5:6
# May 2013 - between: 2:6, 2:7, 3:6, 3:7, 4:6, 4:7
# Nov 2013 - between: 1:6, 2:6, 2:7

```
Of the 63 area- survey combinations 16 were significantly different (Kruskal Wallis rank sum test with Nemenyi post-hoc test, p<0.05). In Nov. 2012 area 1 was significantly different from 7, area 2 from 6 and7, area 3:7, area 4 vs 6 and 7, area 5 vs 6. In May 2013 area 2 was significantly different from 6 and 7, area 3 from 6 and 7, and area 4 from 6 and 7. In Nov 2013 area 1 was significantly different from area 6, while area 2 was significantly different from area 6 and 7.  

#### GAMLSS model of soak times
```{r GAM soak time, echo=FALSE}
#m1 <- gamlss(Fhrs~factor(id)+factor(survey),  family=NO, data=c3)
m1 <- gamlss(Fhrs~factor(id)+random(factor(survey)),  family=NO, data=c3)
t1 <- chooseDist(m1, type="realplus")
getOrder(t1,3)
fm<-update(m1, family=names(getOrder(t1,3)[1]))
#summary(fm)

m2 <- gamlss(Fhrs~factor(id)+factor(survey),  family=NO, data=c3)
t2 <- chooseDist(m2, type="realplus")
getOrder(t2,3)
fm2<-update(m2, family=names(getOrder(t1,3)[1]))


AIC(fm, fm2)
#fm2 - with survey as random factor has lower AIC 

summary(fm2)
fm2
drop1(fm2)

histDist(Fhrs,family="BCPEo", ymax=0.05, nbins=60, data=c3)

```

GAMLSS found the 'BCPEo' to give the best fit to the 'Fhrs' data (see histogram plot).

Using the 'BCPEo' distribution a model of Fhrs by area (as factor) and survey as an ordinary factor showed that all surveys  and areas had a significant effect on the soak time for traps, meaning that soak time varied siginificantly between the areas & surveys. 


### Duration and catch rates of gill-net sets
```{r gillnet set time, echo=FALSE}

c33 <- subset(catch, gear=="GN") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
c33$survey_m <- as.factor(c33$survey_m)


duration.plot.gn <- ggplot(c33, aes(id, Fhrs))

duration.plot.gn <-  duration.plot.gn +  geom_point() + stat_summary(fun.y=mean, geom="point", shape=5, size=3, color="red", fill="red") + labs( x="Management areas", y="Hours fishing (gillnets)")  +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May.2013",
      "Survey 3: Nov. 2013" = "Nov.2013")))

duration.plot.gn

# catch rates for gillnets
cpue.gn <- subset(catch.cpue, gear=="GN") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), CPUEw=sum(CPUEw), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
cpue.gn$survey_m <- as.factor(cpue.gn$survey_m)

ca.plot2<-ggplot(cpue.gn, aes(as.factor(id), CPUEw))


ca.plot2 <- ca.plot2 + geom_boxplot()+ labs( x="Management areas", y="CPUE kg/hour fishing (gillnets)") +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May.2013",
      "Survey 3: Nov. 2013" = "Nov.2013")))
ca.plot2



(duration.plot.gn | ca.plot2) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10)) 

ggsave("./figs/Fig4_gillnet duration CPUE combined.png", height = 3, width = 6)
ggsave("./figs/Fig4_gillnet duration CPUE combined.tiff", height = 3, width = 6)
```
Fishing hours for traps was significantly affected by areas (except area 3 which had a very large variability), however, the number of gillnet sets was very low pr area and survey. 


```{r gillnet fishing hours GAM, echo=FALSE, warnings=FALSE}
m1 <- gamlss(Fhrs~factor(id)+random(factor(survey)),  family=NO, data=c33)
t1 <- chooseDist(m1, type="realplus")
getOrder(t1,3)
fm<-update(m1, family=names(getOrder(t1,3)[1]))
#summary(fm)

m2 <- gamlss(Fhrs~factor(id)+factor(survey),  family=NO, data=c33)
t2 <- chooseDist(m2, type="realplus")
getOrder(t2,3)
fm2<-update(m2, family=names(getOrder(t1,3)[1]))


AIC(fm, fm2)
#fm - with survey as random factor has much, much lower AIC 

summary(fm)
drop1(fm)

histDist(Fhrs,family="BCPE", ymax=0.05, nbins=60, data=c3)

```

Both area and survey were found to be significan variables for explaining fishing hours of gillnets. when the smoothing function was dropped ('drop' function). 

*** 

## Analysis of catches by traits and other factors

### Catch rates pr area & survey
Must aggregate data per station
```{r CPUE traps area, echo=FALSE}

cpue.tr.st <- subset(catch.cpue, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), CPUEw=sum(CPUEw), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
cpue.tr.st$survey_m <- as.factor(cpue.tr.st$survey_m)

ca.plot<-ggplot(subset(cpue.tr.st,  depth!=0), aes(as.factor(id), CPUEw))


#ca.plot <- ca.plot + geom_violin(scale="width", aes(fill=as.factor(id)), draw_quantiles = c(0.5))  + labs(x="Management areas", y="CPUE kg/hour fishing (traps") + scale_fill_manual(name="Management area",values=sequential_hcl(n = 7, h = c(0, -100), c = c(80, NA, 40), l = c(53, 75), power = c(1, 1), rev = TRUE, register = ), guide=FALSE ) +theme_bw()+facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

ca.plot <- ca.plot + geom_boxplot(scale="width", aes( draw_quantiles = c(0.5)))  + labs(x="Management areas", y="CPUE kg/hour fishing (traps") + scale_fill_manual(name="Management area",values=sequential_hcl(n = 7, h = c(0, -100), c = c(80, NA, 40), l = c(53, 75), power = c(1, 1), rev = TRUE, register = ), guide=FALSE ) +theme_bw()+facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

ca.plot

#tiff(file="./figs/catch_rates_traps_area_survey.tiff", width=3000, height=2000, res=400, pointsize=10, compression=c("none"))
#ca.plot
#dev.off()
```


## Statistical analysis CPUE catches
### Testing for normality of CPUEw of trap catches
Shapiro test for normality and Q-Q plots shows that data is non-normal and zero-inflated. 

```{r normality test, echo=FALSE}

#' test for normality
shapiro.test(cpue.tr.st$CPUEw)

#' Q-Q plots
library("qqplotr")
gg <- ggplot(data = cpue.tr.st, mapping = aes(sample = CPUEw,  fill = factor(id))) + stat_qq_band() + stat_qq_line() + stat_qq_point(size=0.2) + facet_wrap(~ id, scales="free") +  labs(x = "CPUEw predicted", y = "CPUEw Observed") + ggtitle("Q-Q plots CPUEw")
gg
```
### Test for difference in CPUEw of traps between areas (non-parametric test)
Both CPUEw  is not significantly different between the areas, 

Significant difference for CPUEW between Nov 2013 survey and the Nov 2012 and May 2013 surveys, but not between the Nov12 and May13 surveys

```{r nonpara ANOVA, echo=FALSE, eval=FALSE}
#### NOT RUN BECAUSE ZERO-ADJUSTED GAM MODEL IS BETTER!

#' 1 - test for difference between areas
kruskal.test(cpue.tr.st$CPUEw, cpue.tr.st$id)

#' Post-Hoc tests of Kruskal - Wallis results
library("PMCMR", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
posthoc.kruskal.nemenyi.test(cpue.tr.st$CPUEw, cpue.tr.st$id, "Chisq")
#' no significant difference in CPUE

#' 2 test for differences between surveys
kruskal.test(cpue.tr.st$CPUEw, cpue.tr.st$survey)

posthoc.kruskal.nemenyi.test(cpue.tr.st$CPUEw, cpue.tr.st$survey, "Chisq")

```

### Zero-inflated GAM model 
This method is more appropriate than the Kruskal-Wallis approach above as it evaluates the effects of all factors at the same time, instead of evaluating the effects of area separate from survey. 

First, developed a model for CPUE (weight and numbers) including depth, area, survey and gear (only traps and gillnets), which performed better than a simpler model excluding gear. 

Also tested models where survey was included as a random factor (using two different approaches: ´random´and ´re´), although this excludes evaluation of the potential significant effects of the surveys on the results. 

Tested models for both CPUE by weight (CPUEw) and CPUE by numbers (CPUEn). 

Model performance were compared based on AIC. 

Model specified:  
CPUEw models:  
* mod1<-gamlss(CPUEw~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA,data=cpue.st)  
* mod2<-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st) 
* mod3<-gamlss(CPUEw~depth+factor(id)+factor(gear)+re(random=~1|survey),family=ZAGA, data=cpue.st)
* mod4 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAGA, data=cpue.st)  
* mod5 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAIG, data=cpue.st)  
* mod6 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+factor(survey),nu.fo=~depth+factor(id)+factor(gear)+factor(survey), family=ZAGA, data=cpue.st) 

Weight with Fhrs as dependent models:
* modA1<-gamlss(weight~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st)  
* modA2 <- gamlss(weight~depth+Fhrs+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st)  

Numbers with Fhrs as dependent model:
* modA4 <- gamlss(number~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st)  


CPUEn models:
* modA3<-gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st)  
* modA5<-gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st)  
* modA6 <- gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st)  
* modA7 <- gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+factor(survey),family=ZAGA, data=cpue.st)



```{r zero-infl model, echo=FALSE}
cpue.st <- subset(catch.cpue, gear=="TB" | gear=="GN") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), CPUEw=sum(CPUEw), CPUEn=sum(CPUEn), weight=sum(weight), number=sum(number), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), gear=first(gear), survey_m=first(survey_m))
cpue.st$survey_m <- as.factor(cpue.st$survey_m)

# Testing different Zero-Inflated models for the data:
# CPUEw - GAMLSS ZAGA model incluing survey, area, depth & gear 
mod1<-gamlss(CPUEw~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

# Model with survey as random effect
mod2<-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st) 

# model with survey as random effect, using re() function from lme
library(nlme)
mod3<-gamlss(CPUEw~depth+factor(id)+factor(gear)+re(random=~1|survey),family=ZAGA, data=cpue.st) 

# specifcying nu.fo
mod4 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAGA, data=cpue.st) 

#  ZAIG model 
mod5 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAIG, data=cpue.st) 

# mod6 survey as normal factor, nu function specified
mod6 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+factor(survey),nu.fo=~depth+factor(id)+factor(gear)+factor(survey), family=ZAGA, data=cpue.st) 

AIC(mod1, mod2, mod3, mod4, mod5)

#alternative model of weight with Fhrs as factor
modA1<-gamlss(weight~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

# modA1 with survey as random factor
modA2 <- gamlss(weight~depth+Fhrs+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st) 

#alt model of numbers with CPUEn
modA3<-gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

# modA3 with number of catch with Fhrs as factor
modA4 <- gamlss(number~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

#modA5 with CPUEn and survey as a random factor
modA5<-gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st) 


#modA6 - modA5 with nu function specified
modA6 <- gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st)

#mod A7 with survey as normal factor, nu function specified
modA7 <- gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+factor(survey),family=ZAGA, data=cpue.st)

AIC(mod1, mod2, mod3, mod4, mod6, modA1, modA2, modA3, modA4, modA5, modA6, modA7)

# Best  model for catch weight is model 6 (CPUEw) while model A7 is the best for numbers (CPUEn)
# the CPUEn (Numbers model) has a much lower AIC than the CPUEw model
summary(mod6)
drop1(mod6)
plot(mod6)
wp(mod6, ylim.all=2); title("model 4 - using 'random(), nu-function specified'")

summary(modA7)
plot(modA7)
drop1(modA7)
wp(modA7, ylim.all=2); title("model 4 - using 'random(), nu-function specified'")

#plotting ZAGA distribution & histogram of CPUEw
plotZAGA(mu=fitted(mod6, "mu")[1], sigma=fitted(mod2, "sigma")[1],nu=fitted(mod2, "nu")[1], main="(a)", ylab="density")

#plotting ZAGA distribution of modA6 (CPUEn)
plotZAGA(mu=fitted(modA7, "mu")[1], sigma=fitted(mod2, "sigma")[1],nu=fitted(mod2, "nu")[1], main="(a)", ylab="density")

#hist(cpue.st$CPUEw, breaks=50)

mod6
modA7

AIC(mod1, mod2, mod3, mod4, mod6, modA1, modA2, modA3, modA4, modA5, modA6, modA7) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
```
##### Choice of models
* CPUEn models had lower AIC than CPUEw 
* models with nu function specified performed better (lower AIC) than models without (for both CPUEw and CPUEn)  
* model with survey as a random factor performed worse (higher AIC) than models with survey as an ordinary factor (for both CPUEw and CPUEn, as well as models with nu function defined)  



##### Model for weight of catch (CPUEw) 
* The best fitting (lowest AIC) model was 'mod6' where survey was an ordinary factor and the nu-function was defined. 
* Area and gear were the only two variables found to be significant for the model when the smoothing function was dropped ('drop1' function)

* For mod6 'gear' and 'survey' (Nov 2013) were significant factors. (intercept and depth were not)

##### Model for number of catch (CPUEn)
* The best fitting (lowest AIC) model was 'modA7' where survey was an ordinary factor and the nu-function specified. 

* For modA7 the variables depth, area 1, area 2, area 5, surveys (all) and gear were significant factors.
* All variable (depth, area, survey and gear) were found to be significant variables in the model when the smoothing function was dropped ('drop1' function)


#### GAM model CPUE - traps only
Statistical analysis of plot of trap catch rates
```{r GAM Traps only, echo=FALSE}

c22 <- subset(cpue.st, gear=="TB")

# Model of CPUEw with survey as random effect
mod22<-gamlss(CPUEw~depth+factor(id)+random(factor(survey)),family=ZAGA, data=c22) 

#model of CPUEw with survey as factor
mod33 <- gamlss(CPUEw~depth+factor(id)+factor(survey),family=ZAGA, data=c22) 

#model of CPUEn with survey as random factor
mod44 <-gamlss(CPUEn~depth+factor(id)+random(factor(survey)),family=ZAGA, data=c22) 

#model of CPUEn with survey as factor
mod55 <- gamlss(CPUEn~depth+factor(id)+factor(survey),family=ZAGA, data=c22) 


AIC(mod22, mod33, mod44, mod55)
#mod55 had the lowest AIC
summary(mod55)
drop1(mod55)
mod55

```

The CPUEn models had better fit than the CPUEw models. 

For the model (mod55) of CPUEn with survey as an ordniary factor both area and survey were significant variable (when excluding the smoothing function), with all surveys and areas 1, 2 and 5 being significant factors in the model 


*** 

#### Bottom depth traps and gillnets
```{r freqplot trap and gillnet depth, echo=FALSE}

ggplot(cpue.st, aes(depth, colour = gear)) +  geom_freqpoly(binwidth = 5) +
  labs(title = "Bottom depth of trap and gill-net stations",
              subtitle = "i.e. fishing depth for traps, while gillnets were floating at the surface and fishing at 0-m depth") 

t.test(subset(cpue.st, gear=="TB")$depth, (subset(cpue.st, gear=="GN")$depth))

```

Depth was, however, not a significant factor in any of the four models developed for the trap CPUE, by weight or numbers. The depth distribution of bottom depth at the trap and gillnet stations (Gillnet fishing depth was at the surface, while trap fishing depth = bottom depth) were significantly different (t-test, p<0.05, df=67.9 -  see also frequncy plot above). Therefore, the models including both gear types led to a wider span and a more diverse distribution of the depths than for the traps-only data set. 

***

### Combine duration and depth plots of traps in one panels
Use 'patchwork' package to arrange plots
```{r trap plots patchwork, echo=FALSE}

#pw1 <- (dp | duration.plot) / ca.plot + plot_annotation(tag_levels = 'A') &   theme(plot.tag = element_text(size = 10)) +theme_minimal()
pw1 <- (duration.plot + dp)/  ca.plot + plot_annotation(tag_levels = 'A') &   theme(plot.tag = element_text(size = 10)) +theme_minimal()
pw1
ggsave("./figs/Fig3_traps combined panel.png")
ggsave("./figs/Fig3_traps combined panel.tiff")
```


*** 

### CPUE by gear type  - by family and trophic group
Only for gillnets and traps and stations with catches (excluding no-catch)
```{r CPUE gear, echo=FALSE}
library(forcats)
# by genus (families)
#catch.3gear<-subset(catch.unmod, gear=="GN" |  gear =="TB")
c4 <- subset(catch.traits, TGShort!="NA" & (gear=="TB" | gear=="GN") &CPUEw>0)


c4$FamGroup2 <- as.factor(capwords(tolower(as.character(c4$FamGroup))))

gear.plot <- c4 %>%  mutate(FamGroup2 = fct_relevel(FamGroup2,  "Other Spp", "Serranidae","Scombridae","Lutjanidae", "Lethrinidae", "Chirocentridae", "Carcharhinidae", "Carangidae",  "Acanthuridae")) %>%
 ggplot( aes(FamGroup2, fill=survey_m)) + geom_bar(binwidt=0.2, aes( weight=CPUEw)) +theme_bw() + facet_grid(vars(gear), vars(survey_m), labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May 2013",
      "Survey 3: Nov. 2013" = "Nov.2013"))) + coord_flip() +xlab("") + ylab("kg/hour fishing (cumulative)")  + guides(fill=guide_legend(title="Survey")) + theme(legend.position = "none") + guides(fill=FALSE) 
gear.plot
#ggsave("./figs/gearplot_species.tiff")


# by trophic group
gear.plot2 <- ggplot(c4, aes(TGShort, fill=survey_m)) + geom_bar(binwidt=0.2, aes( weight=CPUEw)) +theme_bw() + facet_grid(vars(gear), vars(survey_m), labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May 2013",
      "Survey 3: Nov. 2013" = "Nov.2013"))) + coord_flip() +xlab("") + ylab("kg/hour fishing (cumulative)")  + guides(fill=guide_legend(title="Survey")) + theme(legend.position = "none") + guides(fill=FALSE)
gear.plot2
#ggsave("./figs/gearplot_trophic_group.tiff")


# Combine plots in patchwork 
pw2 <- gear.plot2 / gear.plot + plot_layout(guides = "keep") + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10)) & 
  theme(text = element_text(size=5)) +theme(axis.text.y = element_text(size=8))  +theme_minimal() + theme(panel.border = element_rect(linetype = "solid", fill = NA))
pw2  

#pw2 + plot_layout(heights = unit(c(4, 4), c('cm', 'null')))
#ggsave("./figs/gearplot_trophic_group_combined.tiff", width=6, height=6)
#ggsave("./figs/gearplot_trophic_group_combined.png", width=6, height=6)

```

### Multivariate analysis of catch compososition
PCA analysis was carried out to exlore the variability in the catch data.  

PCA was carried out on average catches (CPUE) per survey and area (needed to create a M*N matrix - cannot have uneven number of observations per group). 
```{r PCA catch_weight comp, echo=FALSE, warning=FALSE}

# By trophic group 
# CPUEw
c5 <- subset(c4, CPUEw>0)[,c(1,28,14,37,22)]
c5$index <- paste(c5$gear, c5$survey, c5$id, sep="_")

cc5 <- c5[,c(6,4,5)] %>%
  group_by(index, TGShort) %>%
  summarise(CPUEw=mean(CPUEw))%>%
  pivot_wider(names_from = TGShort, values_from = CPUEw, values_fill = list(CPUEw = 0)) 
cc5<-as.data.frame(cc5)
rownames(cc5) <- cc5$index

cc5$index <- NULL

df_pca <- prcomp(cc5)

plot(df_pca$x[,1], df_pca$x[,2])

df_out <- as.data.frame(df_pca$x)
df_out$gear <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 1 )
df_out$survey <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 2 )
df_out$area <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 3 )
head(df_out)

library(grid) 
library(gridExtra)

percentage <- round(df_pca$sdev / sum(df_pca$sdev) * 100, 2)
percentage <- paste( colnames(df_out), "(", paste( as.character(percentage), "%", ")", sep="") )

p<-ggplot(df_out,aes(x=PC1,y=PC2,color=gear, label=area, shape = factor(survey)))
p<-p +
  geom_point() + 
  geom_text(size=3,  nudge_x = 0.15) + 
  xlab(percentage[1]) + 
  ylab(percentage[2]) + 
  scale_colour_discrete(name  ="Gear",
                            breaks=c("GN", "TB"),
                            labels=c("Gillnet", "Traps")) +
      scale_shape_discrete(name  ="Survey",
                           breaks=c("2012901", "2013002", "2013005"),
                           labels=c("Nov.2012", "May 2013", "Nov. 2013")) +
  theme_bw()
  

df_out_r <- as.data.frame(df_pca$rotation)
df_out_r$Trophic_Group <- row.names(df_out_r)

df_out_r

p2<-ggplot(df_out_r,aes(x=PC1,y=PC2,label=Trophic_Group,color=Trophic_Group ))
p2<-p2+geom_point() + geom_text(size=3) + 
  xlab(percentage[1]) + 
  ylab(percentage[2])+ theme_bw()

pw3 <- p / p2
pw3

#ggsave("./figs/PCA_catchcomp_weight.tiff", width=6, height=6)
#ggsave("./figs/PCA_catchcomp_weight.png", width=6, height=6)
```

##### Combine gearplot and PCA
```{r gearplot pca, echo=FALSE}
pw2 | pw3 

#gear.plot2| pw3 

ggsave("./figs/Fig5_gearplot PCA.tiff", width=8, height=6)
ggsave("./figs/Fig5_gearplot PCA.png", width=8, height=6)
```


PCA of catch weight and numbers (CPUEw and CPUEn) by trophic group  gave similar results and showed how trap and gillnet catches differed. The first two principal components explained 78.7% of the variation. Catches of Planktivores drove the variability along PC1 with gillnet catches in area 2 during the Nov. 2013 survey having high catches of planktivores compared to the other data points. PC2 was driven by the catches of herbivores which had high catches in the traps, and carnivores with higher catches in the gillnets. Catches of coralivores and invertivores did not contribute to the variability in catches (but these were caught in low quantities in just a few surveys and areas).  
  
Conclusion:
Trap catches were dominated by herbivores, gillnet catches by carnivores, while gillnet catches in area 2 during the Nov. 2013 survey had very high catches of planktivores compared to other gears, surveys and areas. 


However, this is still descriptive. Need to evaluate the differences statistically. Will use GAM model.   
(This also allows to use data on station level, not just average catches per area/survey needed to construct a matrix necessary for PCA)


```{r GAM model catch comp, echo=FALSE, warnings=FALSE}

#CPUEw data only as the catch figure only looks at catch weight. 
m1 <- gamlss(CPUEw~factor(TGShort)+factor(survey)+factor(gear), family=NO, data=na.omit(subset(c4, CPUEw>0)))

t1 <- chooseDist(m1, type="realplus")
getOrder(t1,3)
cmod1<-update(m1, family=names(getOrder(t1,3)[1]))

summary(cmod1)
drop1(cmod1)

histDist(CPUEw,family="GIG", ymax=0.05, nbins=20, data=subset(c4, CPUEw>0))


```
Gear and trophic groups were significant variables in the model when the smoothing funciton was dropped. In the full model gears, the Nov. 2012 and Nov. 2005 surveys as well as the carnivores (intercept), coralivors, herbivores and invertivores were all significant factors affecting the catch rates (CPUEw) in the GAM model of CPUEw by trophic group, survey and gear (Generalised Inverse Gaussian distribution, AIC: -870, df: 9). 

Gear had a highly significant impact on the catch composition, and all tropic groups except planktivores had a significant effect on catches. This is different from the PCA results where planktivores were a very clear factor explaining the variability, but they were caught in just 14 stations.   

Conclusion from PCA and GAM model:  
* Gear significantly affects catch rates  
* Trophic groups (except planktivores) significantly affect catch rates  
* Both Nov surveys (2012 and 2013) had significant effect on catches


***

#### Test differences in CPUE By Species in trap catches, by range of traits and factors
Use GAM model and evaluate how CPUE by weight (CPUEw) was affected by physical / area /surve factors and the traits :
- depth
- survey (random factor)
- area
- family group
- trophic group
- trophic level (linked to trophic group)
- Place in water column
- Diel activity
- Habitat 
- Gregariousness
- MaxLength

```{r GAM CPUEw by all factor, echo=FALSE}

#mod6<-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey))+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+factor(FamGroup2),family=ZAGA, data=na.omit(c4)) 
#summary(mod6)

#find best-fitting distribution
ma <- gamlss(CPUEn~depth+factor(id)+random(factor(survey))+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=NO, data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 

t1 <- chooseDist(ma, type="realplus")
getOrder(t1,3)
#cmod1<-update(ma, family=names(getOrder(t1,3)[1]))

# traps only, CPUE by numbers, survey as random factor
mod7<-gamlss(CPUEn~depth+factor(id)+random(factor(survey))+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
#summary(mod7)

# traps only, CPUE by numbers, survey as ordinary factor
mod8 <- gamlss(CPUEn~depth+factor(id)+factor(survey)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
#summary(mod8)

# without areas
mod9 <- gamlss(CPUEn~depth+factor(survey)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 

#without surveys
 mod10 <- gamlss(CPUEn~depth+factor(id)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
 
 #without areas + surveys
 mod11 <-  gamlss(CPUEn~depth+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
 
 # without surveys and depth
 mod12 <- gamlss(CPUEn~factor(id)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
 
 # just traits
 mod13 <- gamlss(CPUEn~TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 

AIC(mod7, mod8, mod9, mod10, mod11, mod12, mod13)
#mod7 had lowest AIC
summary(mod7)

```
Evaluting catches of fish in relation to their traits. Should be evaluated by numbers, for single large fish not to dominate the results. The model based on CPUE by numbers (mod7, for traps only, CPUE by numbers, survey as random factor) had  the lowest AIC.  Also, including survey as a random factor led to lower AIC than including it as an ordinary factor. 

Model (BCPOe Box-Cox Power Exponential-orig. distribution, AIC: -1603.015, df:27) results show that numbers of fish caught (CPUE by numbers) was significantly affected by:  
* all areas
* all traits, except MaxLength and WaterColumn (demersal)

Interpretation of results: 
If depth was included it was not a significant factor. CPUEn varies significantly by areas and by traits, and with the variability being consistent this indicates regional differences in catches of different trophic groups / traits /species. 
 

```{r histogram max lenght, echo=FALSE}
ggplot(subset(c4, gear=="TB"), aes(MaxLength)) +geom_freqpoly(binwidth = 5)
```



### CPUE by trophic group by area & by survey (year) 
FIG 5 in Feb 2019 version of MS

Presents the CPUE pr hr, for each management area and survey, standardized by the number of traps set in each area X survey combination. 

Trap catches were dominated by carnivores, occuring in all area X survey combinations, followed by invertivores who also occurred everywhere, albeight in lower densities than the carnivores. 

Cathces of planktivores and invertivores varied substantially between areas and surveys, in contrast to carnivores who were caught in all surveys and areas. This explains why invertivores and planktivores were signifant factors on the catches (GAM model of CPUEn with traits), while carnivores were not. 

*Area 2, 5 and 6 seem to have the highest diversity of trophic groups, but this has to be calculated as functional diversity, using the FD package (or similar). *

```{r trophic plot, echo=FALSE}
trophic.plot <- ggplot(subset(catch.traits, TGShort!="NA" & gear=="TB"), aes(TGShort, CPUEw/NArea))

trophic.plot <- trophic.plot + geom_col(aes(fill=TGShort)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Trophic group",values=qualitative_hcl(n = 5, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / (number of traps pr area)") + theme_bw() 
trophic.plot
ggsave("./figs/S2_trophic_group_cpue.png")

tiff(file="./figs/S2_trophic_group_cpue.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
trophic.plot
dev.off()
```


### Trophic group CPUE by depth
A modified version of Figure 6 in Feb 2019 MS. 

Basically a more complex version of the previous plot. Adds the depth dimension to the plot, and the surveys as colours. 

Shows uniform catch rates of carnivores and invertivores from 0-50m. 

All surveys seem to overlap, so no difference in trophich group depth dependent catch rates between the surveys.

```{r trophic depth plot, echo=FALSE}
depth.plot <- ggplot(subset(catch.traits, gear=="TB" & TGShort!="NA"), aes(depth, CPUEw)) 

depth.plot <- depth.plot + geom_point(aes(colour=survey_m))  + facet_grid(vars(id),vars(TGShort)) +  scale_colour_manual(name="Survey",values=qualitative_hcl(n = 3, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x="Depth (m)", y="CPUE (kg(hrs)")  +theme_bw()  

depth.plot

tiff(file="./figs/trophic_group_cpue_depth.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
depth.plot
dev.off()
```


### Trophic level in Trap catches
```{r trophic level, echo=FALSE}
TMean <- subset(catch.traits, gear=="TB" & TrophicLevel!="NA") %>% group_by(id, survey_m) %>% summarise(TM=mean(na.omit(TrophicLevel)))
CMean <- subset(catch.traits, gear=="TB" & TrophicLevel!="NA") %>% group_by(id, survey_m) %>% summarise(CM=mean(CPUEw))
TMean$CM <- CMean$CM

t0.plot <- ggplot(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"), aes(TrophicLevel, CPUEw)) 

t0.plot <- t0.plot + geom_point(aes(colour=TGShort)) + geom_vline(data = TMean, aes(xintercept = TM)) + facet_grid(vars(id),vars(survey_m)) +  scale_colour_manual(name="Trophic group",values=qualitative_hcl(n = 5, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x="Trophic level", y="CPUE (kg(hrs)")  +theme_bw()  
t0.plot

tiff(file="./figs/trophic_level.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t0.plot
dev.off()
```

#### GAM model of trophic level of catches
```{r GAM trophic level, echo=FALSE, warning=FALSE}


tl1 <- gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=NO, data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

t11 <- chooseDist(tl1, type="realplus")
getOrder(t11,3)

names(getOrder(t1,3)[1])

tl1 <- gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=names(getOrder(t1,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

tl2 <- gamlss(TrophicLevel~depth+factor(id)+random(factor(survey)), family=names(getOrder(t1,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

tl3 <- gamlss(TrophicLevel~depth+factor(id)+factor(survey), nu.formula = gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=names(getOrder(t1,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"))), family=names(getOrder(t1,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

tl4 <- gamlss(TrophicLevel~depth+factor(id)+random(factor(survey)), nu.formula = gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=names(getOrder(t1,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"))), family=names(getOrder(t1,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

AIC(tl1, tl2, tl3, tl4)

summary(tl1)

```

The GAM Model (Box-Cox Power Exponential, AIC: 331.72, df: 12) of trophic level by depth, area and surveys only showed area 3 and the intercept to be significant factors affecting the Trophic level of catches meaning that trophic level was similar in all areas except area 3 (and 1)



### Maxlength in catches
```{r maxlength, echo=FALSE}
t0.plot <- ggplot(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"), aes(MaxLength, CPUEn)) 

t0.plot <- t0.plot + geom_point(aes(colour=TGShort)) + facet_grid(vars(id),vars(survey_m)) +  scale_colour_manual(name="Trophic group",values=qualitative_hcl(n = 5, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x="Max lenght(cm)", y="CPUE (no. fish/hour)")  +theme_bw()  
t0.plot
ggsave("./figs/S6_max_length.png")

tiff(file="./figs/S6_max_length.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t0.plot
dev.off()


```


### Place in water column
```{r place in water column, echo=FALSE}
catch.traits$WaterCol[catch.traits$WaterCol=="Demersal"] <- "demersal"
tl.plot <- ggplot(subset(catch.traits, WaterCol!="NA" & gear=="TB"), aes(WaterCol, CPUEw/NArea))

tl.plot <- tl.plot + geom_col(aes(fill=WaterCol)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Place in water column",values=qualitative_hcl(n = 6, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / number of traps pr area") + theme_bw() + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
tl.plot
ggsave("./figs/S3_water_col.png")

tiff(file="./figs/S3_water_col.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
tl.plot
dev.off()
```

### Diel activity
```{r diel activity, echo=FALSE}
t2.plot <- ggplot(subset(catch.traits, DielActivity!="#N/A" & gear=="TB"), aes(DielActivity, CPUEw/NArea))

t2.plot <- t2.plot + geom_col(aes(fill=DielActivity)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Diel activity",values=qualitative_hcl(n = 6, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / number of traps pr area") + theme_bw() + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
t2.plot
ggsave("./figs/S4_diel_act.png")

tiff(file="./figs/S4_diel_act.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t2.plot
dev.off()
```


### Gregariousness
```{r Gregariousness, echo=FALSE}
t3.plot <- ggplot(subset(catch.traits, Gregariousness!="#N/A" & gear=="TB"), aes(Gregariousness, CPUEw/NArea))

t3.plot <- t3.plot + geom_col(aes(fill=Gregariousness)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Gregariousness",values=qualitative_hcl(n = 6, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / number of traps pr area") + theme_bw() + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
t3.plot

ggsave("./figs/S5_gregariousness.png")

tiff(file="./figs/S5_gregariousness.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t3.plot
dev.off()
```




***
## Biodiversity (species densities, trophic diversity etc)


### Aggregated Species density per area for (traps only)
Species per area pr hour of fishing, traps only.

```{r species density, echo=FALSE}
sp.pr.area <- subset(catch.unmod, gear=="TB") %>% dplyr::group_by(id, survey_m) %>% dplyr::summarise(n_distinct(species[species!="NOCATCH"]), n_distinct(ss), sum(Fhrs))
colnames(sp.pr.area) <- c("id", "survey","Nsp","NTraps", "Fhrs")

sp.pr.area$Species_by_NoStations <- (sp.pr.area$Nsp) / sp.pr.area$NTraps
sp.pr.area$Species_Hrs <- (sp.pr.area$Nsp) / sp.pr.area$Fhrs
write.csv2(sp.pr.area, "./figs/species_density_area.csv")

#calculate species density pr area (all years combined)
sp.pr.area2 <- subset(catch.unmod, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise(n_distinct(species[species!="NOCATCH"]), n_distinct(ss), sum(Fhrs))
colnames(sp.pr.area2) <- c("id","Nsp","NTraps", "Fhrs")
sp.pr.area2$Species_by_NoStations <- (sp.pr.area2$Nsp) / sp.pr.area2$NTraps
sp.pr.area2$Species_Hrs <- (sp.pr.area2$Nsp) / sp.pr.area2$Fhrs

#combined table of species-hrs pr survey & total
sp.area.comb <- bind_cols(subset(sp.pr.area, survey=="Survey 1: Nov. 2012")[,c(1,5,7)], subset(sp.pr.area, survey=="Survey 2: May 2013")[,c(5,7)], subset(sp.pr.area, survey=="Survey 3: Nov. 2013")[,c(5,7)])

colnames(sp.area.comb) <- c("Area", "H1","Nov.2012","H2", "May 2013", "H3", "Nov.2013")

sp.area.comb$Average <- (sp.area.comb$H1*sp.area.comb$Nov.2012 + sp.area.comb$H2*sp.area.comb$`May 2013`+ sp.area.comb$H3*sp.area.comb$Nov.2013)/(sp.area.comb$H1+sp.area.comb$H2+sp.area.comb$H3)

sp.area.comb[,c(1,3,5,7,8)] %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
```

The highest number of species was observed in area 2 (36), followed by area 3, 6 and 7 (25 in each). 

Average species density across the three surveys(number of species pr hour of fishing - soak time of traps) ranged from 0.01204 (area 2) to 0.02359 (area 4). Area 4 had the highest species density across all surveys (table above), while the area with the lowest species density varied by survey: area 1 in November 2012 , area 7 in May 2013 , and area 2 in November 2013. 


### Species density pr station - Zero Adjusted GAM model

```{r GAM - species densities, echo=FALSE}

spue.df <-  subset(catch.unmod, gear=="TB") %>% dplyr::group_by(ss) %>% dplyr::summarise(survey=first(survey), area=first(id), Nsp= n_distinct(species[species!="NOCATCH"]), depth=first(depth), Fhrs=sum(Fhrs))
spue.df$Species_Hrs <- spue.df$Nsp / spue.df$Fhrs

#hist(spue.df$Species_Hrs)

#find best-fitting distribution. 
mod.sd1 <- gamlss(Species_Hrs~depth+factor(area)+factor(survey),  family=ZAGA, data=spue.df)
mod.sd2 <- gamlss(Species_Hrs~depth+factor(area)+random(factor(survey)),  family=ZAGA, data=spue.df)
mod.sd3 <- gamlss(Species_Hrs~depth+factor(area)+factor(survey),  nu.formula = Species_Hrs~depth+factor(area)+factor(survey), family=ZAGA, data=spue.df)
mod.sd4 <- gamlss(Species_Hrs~depth+factor(area)+random(factor(survey)), nu.formula = Species_Hrs~depth+factor(area)+random(factor(survey)), family=ZAGA, data=spue.df)
mod.sd5 <- gamlss(Species_Hrs~depth+factor(area)+factor(survey),  nu.formula = Species_Hrs~depth+factor(area)+factor(survey), family=ZAIG, data=spue.df)




AIC(mod.sd1, mod.sd2, mod.sd3, mod.sd4, mod.sd5)

#Best model: mod.sd3  with survey as ordinary factor, nu.formula specified has lowest AIC

summary(mod.sd3)

#plot(fm)
# Significant factors:  intercept, areas 2, 3, 4, 5 and surveys 

```
The variability and relative difference in rank of species density per area and survey as observed in the table above was confirmed by the zero-adjusted GAMLSS model with specified nu-function (with "ZAGA" distribution,  AIC: -1015, df: 21) where all surveys and areas 1, 2, 3, 4, and 5  (but not depth) were significant factors in the model. 



*** 

### Functional diversity
We used the same approach as Stuart-Smith et al to exclude very few observations of a single species and excluded all species observations occuring in 3 or fewer stations (traps). 

To avoid dbFD crashing 'm' was set in the 'dbFD' call (the number of PoCA  axes kept as traits to do the FRic analysis). Several levels of 'm' were tested, and this could probably be tested further (to higher levels of 'm')

##### Results for n_spec > 3, m=10
Results based on the output from the dbFD analysis:

Overall Fric (R2)=  0.662


```{r functional diversity, echo=FALSE, warning=FALSE}
#ss_list <- levels(catch1$survey)
sp_occur <- subset(catch1, CPUEn>0 & gear=="TB")  %>% dplyr::group_by(Sci_name) %>% dplyr::summarise(n())
colnames(sp_occur) <- c("Sci_name", "n_spec")

# wrangle traits into a traitstable that can be used in FD
missing <- setdiff( x=traits$x1, y=subset(sp_occur, n_spec>3)$Sci_name)
t5 <- traits[!traits$x1 %in% missing,]
#t5 <- traits[traits$x1 %in% subset(sp_occur, n_spec>2)$Sci_name,]
tr <- t5[,c(4:10)]
rownames(tr) <- t5$x1
tr[(tr=="#N/A")] <- c(NA)
tr <- droplevels(tr)
tr$diel<-as.integer(as.factor(tr$Diel.Activity))
tr$diel[(tr$diel==2)] <- c(0)
tr <- tr[,c(1,2,3,4,6,7,8)]
#convert character variables to factors
tr$Trophic.group <- as.factor(tr$Trophic.group)
tr$Water.column <- as.factor(tr$Water.column)
tr$Habitat <- as.factor(tr$Habitat)
tr$Gregariousness <- as.factor(tr$Gregariousness)



# wrangle 'catch1' to aggregate CPUE pr area (row) pr species (columns)
missing <- setdiff( x=catch1$Sci_name, y=rownames(tr))
c5 <- catch1[!catch1$Sci_name %in% missing,]
#c_melt <- melt(c5[,c(28,11,22)], id=c("id", "Sci_name")) # weight by CPUEw
c_melt <- melt(c5[,c(28,11,23)], id=c("id", "Sci_name")) # weight by CPUEn

#convert abundance to integer for better calculation performance
med_int1000 <- function(x) as.integer(median(x)*1000)
abund <- dcast(c_melt, id ~ Sci_name, value.var="value", fun=med_int1000) 
# to calculate with raw abundance data, use line below:
#abund <- dcast(c_melt, id ~ Sci_name, value.var="value", fun=median)
abund[is.na(abund)] <- 0
abund <- abund[,c(2:length(abund))]

#calculate FD using dbFD function, m set to 10 to avoid crach (int overload in QHULL)
FuncDiv <- dbFD(tr, abund, corr = c("lingoes"), m=10)

FDt <- as.data.frame(rbind(FuncDiv$FEve, FuncDiv$FDiv, FuncDiv$FDis, FuncDiv$RaoQ))
rownames(FDt) <- c("FEve", "FDiv", "FDis", "RaoQ")
colnames(FDt) <- c("A1", "A2", "A3", "A4", "A5", "A6", "A7")

FDt <- as.data.frame(t(round(FDt, digits=3)))

# Nice-looking table using 'kable', highlighting highest values in red
FDt %>%
  dplyr::mutate(
    Area = cell_spec(row.names(.), color = "black"),
    FEve = cell_spec(FEve, "html", color = ifelse(FEve >= max(FEve), "red", "black")),
    FDiv = cell_spec(FDiv, "html", color = ifelse(FDiv >= max(FDiv), "red", "black")),
    FDis = cell_spec(FDis, "html", color = ifelse(FDis >= max(FDis), "red", "black")),
    RaoQ = cell_spec(RaoQ, "html", color = ifelse(RaoQ >= max(RaoQ), "red", "black"))
  ) %>%
  dplyr::select(Area, FEve, FDiv, FDis, RaoQ) %>%
  kable(format = "html", escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Rerunning the FD model excluding one trait at a time
Need to reduce 'm' to 9 to avoid crash:

*Zero distance(s)Error in convhulln(tr.FRic, "FA") :* 
  *Received error code 2 from qhull. Qhull error:*
    *QH6114 qhull precision error: initial simplex is not convex. Distance=1.4e-16* 
    
Removing the MaxLenght  or Trophic level traits from the model lead to the largest increase of R2 (by 31% and 22% respectively) compared to the model with all traits included, and higher than removing any of the other traits from the model . R2 was reduced when removing any of the other five traits from the model, indicating that these traits should be kept in the model. 

Reran the model excluding both MaxLength and Trophic Level:  


Evaluation of runs:
* Use the model without MaxLenght and Trophic Level
* Removing Maxlength makes sence because the data included a few catches of sharks with very large MaxLengt (>2m) that skews the MaxLenght distribution. Excluding MaxLength creates an analysis around traits that are more common in distribution across species. 
  + Also, the sharks are rowing predators, not so site attached (but that also applies to some pelagic species, especially the large ones, so the same argument applies for these - excluding large body size reduces the importance of these non-site attached species)
* Removing TrophicLevel would be linked to MaxLength as the largest fish would be the apex predators (e.g. sharks)
  
```{r FD model excluding traits, echo=FALSE, warning=FALSE}
# create data frame with original RaoQ and FRic
Raoq <- as.data.frame(c(FuncDiv$RaoQ, FuncDiv$qual.FRic))
colnames(Raoq) <- c("All")
rownames(Raoq) <- c("A1", "A2", "A3", "A4", "A5", "A6", "A7", "R2")


# select tr, but excluding one variable at a time
#tr[,c(1,!2,3,4,5,6,7)]
for (i in 1:7) { 
  FDout <- dbFD(tr[,c(setdiff(1:7, i))], abund, corr = c("lingoes"), m=9)
  raoq1 <- as.data.frame(c(FDout$RaoQ, FDout$qual.FRic))
  colnames(raoq1) <- colnames(tr)[i]
  Raoq <- cbind(Raoq, raoq1)
}

#model excluding MaxLength and Trophic Level
FDout1 <- dbFD(tr[,c(3:7)], abund, corr = c("lingoes"), m=10)
raoq11 <- as.data.frame(c(FDout1$RaoQ, FDout1$qual.FRic))
colnames(raoq11) <- c("ML_TL")
Raoq <- cbind(Raoq, raoq11)

#r2 for all models
formattable(round(Raoq[8,], digits=3))

#R2 per area and model
formattable(round(Raoq[c(1:7),], digits=3), list(    MaxLength = color_tile("transparent", "lightpink"),     Trophic.Level = color_tile("transparent", "lightpink"),     Trophic.group = color_tile("transparent", "lightpink"),    Water.column = color_tile("transparent", "lightpink"), Habitat = color_tile("transparent", "lightpink"),    Gregariousness = color_tile("transparent", "lightpink"), diel = color_tile("transparent", "lightpink"), ML_TL= color_tile("transparent", "lightpink")))

write.csv2(Raoq, "./figs/Raoq_table.csv")

```


***
## Results table
This table combines CPUE, traits pr gear type, species density and RaoQ into one results-table. 

```{r results table, echo=FALSE}
st2 <- catch %>% dplyr::group_by(ss) %>% dplyr::summarise(first(id), first(Fhrs), first(gear), sum(weight), sum(number))
colnames(st2) <- c("ss", "id", "Fhrs","gear", "weight","number")
st2$CPUEw <- st2$weight/st2$Fhrs
st2$CPUEn <- st2$number/st2$Fhrs

results.table <- data.frame(area=(1:7))
results.table <- cbind(results.table,(subset(st2, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEw)))[,2])
results.table <- cbind(results.table,(subset(st2, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEw)))[,2])
results.table <- cbind(results.table,(subset(st2, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEn)))[,2])
results.table <- cbind(results.table,(subset(st2, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEn)))[,2])
results.table <- cbind(results.table,(subset(catch.traits, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(TrophicLevel, na.rm = TRUE)))[,2])
results.table <- cbind(results.table,(subset(catch.traits, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(TrophicLevel, na.rm = TRUE)))[,2])
results.table<- cbind(results.table,(subset(catch.traits, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(as.integer(Gregariousness), na.rm = TRUE)))[,2])
results.table<- cbind(results.table,(subset(catch.traits, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(as.integer(Gregariousness), na.rm = TRUE)))[,2])
colnames(results.table) <- c("area", "TrapCPUEw", "GillnetCPUEw", "TrapCPUEn", "GillnetCPUEn", "TrophicL_Traps", "TrophicL_Gillnets", "Greg_Traps", "Greg_Gillnets" )

TMean <- subset(catch.traits, gear=="TB" & TrophicLevel!="NA") %>% dplyr::group_by(id, survey_m) %>% dplyr::summarise(TM=mean(na.omit(TrophicLevel)))

results.table$SpeciesDensity <- sp.area.comb$Average
results.table$RaoQ <- Raoq$ML_TL[1:7]

# formattable(round(results.table, digits = 3))

write.csv2(round(results.table, digits = 3), "./figs/results_table.csv")

results.table %>%
  kable(format = "html", escape = F, digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  

```

