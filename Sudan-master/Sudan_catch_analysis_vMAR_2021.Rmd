---
title: "Sudan_catch_analysis"
author: "Erik Olsen"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  html_document: default
  pdf_document: default
---
# Analysis of Sudan survey data 2012 - 2013

This R-markdown document contains all r-code used to carry out the analysis for the paper on fish catch rates and biodiversity along the Red Sea coast of Sudan. The analysis is based on three surveys: November 2012, May 2013 and November 2013. 

Here the analysis is structured around the 7 management regions of the Sudanese Red Sea coast as follows:

- Present the region: Bathymetric map
- Sampling locations
- Table of effort (diffent gear types per management areas.)
- Table of species / families caught
- Depth distribution of traps by survey and area
- Catch CPUE by area and survey
- Catch CPUE distribution by gear, by species groups (should perhaps do the same for trophic groups)
- PCA analysis of species and trophic groups in catches
- CPUE by trophic group pr area and survey
- CPUE by depth and tropich group and survey
- Statistical analysis
  - test of normality shows that we need to use non-parametric and zero-adjusted approaches. 
  - CPUE as a function of area, depth, survey, gear (Zero-adjusted model)
- Biodiversity analysis
  - Species accumulation curves
  - Functional diversity (RaoÂ´s Q)
  
All code and data are stored on GitHub

## Libraries, data etc. 
### Libraries, dependencies and functions
```{r libraries and dependencies, echo=FALSE, warning=FALSE, message=FALSE}
library(reshape2)
library(maps)
library(mapdata)
library(ggplot2)
library(RColorBrewer)
library(sp)
library(rgdal)
library(rgeos)
# plyr mus be loaded befor dplyr for both to work
library(plyr) 
library(dplyr)
library(tidyr)
library(knitr)
library(kableExtra)
library(maptools)
library(marmap)
library(classInt)
library(colorspace)
library("formattable")
library("PMCMR")
library(FD)
library("gamlss")
library(patchwork)
```


```{r functions, echo=FALSE}

capwords <- function(s, strict = FALSE) {
  cap <- function(s) paste(toupper(substring(s, 1, 1)),
                           {s <- substring(s, 2); if(strict) tolower(s) else s},
                           sep = "", collapse = " " )
  sapply(strsplit(s, split = " "), cap, USE.NAMES = !is.null(names(s)))
}
```


### Load and manipulate data
Reading catch, station and traits data. 

Neither station data, nor catch data has a complete depth record, but by combining depth para from each we can get a complete depth parameter for all stations. 
```{r load data, echo=FALSE}
#' Catch data
catch<-read.csv2("catch.csv")
catch <- catch[,c(1:15, 17:24)]
catch$survey<-as.factor(catch$survey)
catch$CPUEw<-catch$weight/catch$Fhrs
catch$CPUEn<-catch$number/catch$Fhrs

#' Station
station <- read.csv2("stations.csv")

#' add depth to catch from station
catch$d1<- station$geardepthstart[match(catch$ss, station$ss)]  
catch$depth <- apply(X=cbind(catch$bdep, catch$d1), MARGIN=1, FUN=max, na.rm=TRUE)

#' Add Month. Year survey column
catch$survey_m<-as.character(catch$survey)
catch$survey_m<-replace(catch$survey_m, grep("2012901", catch$survey_m), "Survey 1: Nov. 2012")
catch$survey_m<-replace(catch$survey_m, grep("2013002", catch$survey_m), "Survey 2: May 2013")
catch$survey_m<-replace(catch$survey_m, grep("2013005", catch$survey_m), "Survey 3: Nov. 2013")

#'Traits
traits <- read.csv2("traits_noNa.csv")
```


### Sudan map and management areas
Loads the map data for Sudan, loads the management areas from shape-file etc. 
```{r map data, echo=FALSE, warning=FALSE}
#' SUDAN MAP DATA
world<- map_data("worldHires", c("Sudan", "Ethiopia")) 
world$survey_m<-c("Survey 1: Nov. 2012")
world2<-world
world2$survey_m<-c("Survey 2: May 2013")
world3<-world
world3$survey_m<-c("Survey 3: Nov. 2013")
world<-rbind(world, world2, world3)

#'  SPATIAL POLYGONS FOR MANAGEMENT AREAS
#setwd("/Users/eriko/Documents/GitHub/Sudan2019/Sudan-master")
setwd("/Users/eriko/GitHub/Sudan2019/Sudan-master")
setwd("./sudan_management_areas")
ManageAreas<-readOGR(dsn = ".", "sudan_regions")
setwd("..")

#' setting correct projection LAT LON
ManageAreas <- spTransform(ManageAreas, CRS("+proj=longlat +ellps=GRS80"))

#' Create  area map with numbers for each region
ManageAreas.f<-fortify(ManageAreas, region="id") #creates X - Y points of the polygons
cnames <- aggregate(cbind(long, lat) ~ id, data=ManageAreas.f, FUN=function(x)mean(range(x)))
cnames$id<-c(1:7)

#' position of Port Sudan
ps<-rbind(data.frame(x=37.21709967,y=19.600512, group=1, survey_m=c("Survey 1: Nov. 2012")),data.frame(x=37.21709967,y=19.600512, group=1, survey_m=c("Survey 2: May 2013") ),data.frame(x=37.21709967,y=19.600512, group=1, survey_m=c("Survey 3: Nov. 2013") ))
```

### Allocating catch positions to management areas
Adds 'Area' to each line in the catch table. 
```{r catch pos to mngmt areas, echo=FALSE}
#' Create spatial.points data base from catch
catch.points<- SpatialPoints(catch[13:14])
proj4string(catch.points) <- proj4string(ManageAreas)
catch.areas<-over(catch.points, ManageAreas)

#' fix area number to area name
alist<-data.frame(name=levels(as.factor(catch.areas$name)), id=c(7,3,2,1,4,5,6))
catch <- cbind(catch, catch.areas[2])
catch$id <- alist$id[match(catch$name, alist$name)]  

#' allocate management areas to catches outside of polygons (choose nearest polygon)
naarea <- catch[is.na(catch$id),]
naarea$id <- naarea$Area
naarea$name[1] <- c("Arakiai")
naarea$name[2:8] <- c("Suakin Archipelago")
naarea$name[9:16] <- c("Donganab")
catch<- rbind(subset(catch, id>=1), naarea) 

#' Change family names to Upper & Lower case
#catch$FamGroup2 <- paste(toupper(substr(catch$FamGroup, 1, 1)), tolower(substr(catch$FamGroup, 2, 20)), sep="")
#catch$FamGroup2 <- as.factor(catch$FamGroup2)
```




### Modifying dataset and creating one dataset for CPUE analysis and another for traits
Of the catch data, 12 fish registrations lack weight, (i.e. this was forgotten entered into the database during the survey). These registrations, would if included lead to 12 more registrations of CPUE = 0. 
```{r nocatch dataset, echo=FALSE}
#' Keep a copy of original 'catch'
catch.unmod <- catch

#' remove Hand Line stations with too short time <1 hr, and too long time >8 hrs
# hist((subset(catch, gear=="HL" & Fhrs>0))$Fhrs, breaks =20) # get an idea of the spread in fishing time
catch <- rbind(subset(catch, gear!="HL"), subset(catch, gear=="HL" & Fhrs>1 & Fhrs<8))

#' remove 14 records where weight of fish has not been recorded
names <- row.names(subset(catch, weight==0 & number>0))
catch.cpue <- subset(catch, !(rownames(catch) %in% names))


#' selecting only stations with catch & removes stations shorter than 1 hour - two handline stations with fishing time recorded as 5min, that we know is wrong, but we don't have the correct time. 
catch1<-subset(catch, Sci_name!="No catch" & Sci_name!="NO CATCH") 

```

### Adding traits to 'catch' data set (without 0-catch stations)
Some more data wrangling that adds the traits from the traits table to the catch data, using only the station with catches (there are no traits for 'NOCATCH' species). 

Also, only select traps, gillnets and handlines as these were the only gear with sufficient numbers and consistent use to be analyzed. 

Lastly adds number of gear deployed at each station to each line. 
```{r add traits,  echo=FALSE}
catch.traits <- catch1
catch.traits$MaxLength<- traits$MaxLength[match(catch1$Sci_name, traits$x1)]  
catch.traits$TrophicLevel<- traits$Trophic.Level[match(catch1$Sci_name, traits$x1)]  
catch.traits$TrophicGroup<- traits$Trophic.group[match(catch1$Sci_name, traits$x1)] 
catch.traits$WaterCol<- traits$Water.column[match(catch1$Sci_name, traits$x1)] 
catch.traits$DielActivity<- traits$Diel.Activity[match(catch1$Sci_name, traits$x1)] 
catch.traits$Habitat<- traits$Habitat[match(catch1$Sci_name, traits$x1)] 
catch.traits$Gregariousness<- traits$Gregariousness[match(catch1$Sci_name, traits$x1)] 
catch.traits$Sci_name_New<- traits$x2[match(catch1$Sci_name, traits$x1)] 
catch.traits$Gregariousness[catch.traits$Sci_name=="Lethrinus mahsena"] <- c(2)
catch.traits$Gregariousness[catch.traits$Sci_name=="Sphyraena jello"] <- c(3)
catch.traits$Gregariousness[catch.traits$Sci_name=="Thunnus albacares"] <- c(3)
catch.traits$Gregariousness[catch.traits$Gregariousness=="#N/A"] <- NA

catch.traits$Gregariousness <- droplevels(as.factor(catch.traits$Gregariousness))

#' collate Trophic groups and give shorter names
tn<-data.frame(TCat=levels(as.factor(catch.traits$TrophicGroup)), short=c("Invert.", "Herb.", "Coral.", "Carni.", "Plankt.", "Herb."))
catch.traits$TGShort <- tn$short[match(catch.traits$TrophicGroup, tn$TCat)]

#' select only Traps, Gillnet and Handline
catch.traits <- subset(catch.traits, gear=="HL" | gear=="TB" | gear=="GN")
catch.traits$ss1 <- as.factor(catch.traits$ss)

#' add number of stations in that area to each line
c3 <- catch.traits %>% dplyr::group_by(ss1) %>% dplyr::summarise( first(depth), first(gear), first(id), first(survey), first(survey_m))
colnames(c3) <- c("ss", "depth", "gear", "id", "survey", "survey_m")
n.area <- c3 %>% dplyr::group_by(id) %>% dplyr::summarise(n_distinct(ss))
colnames(n.area) <- c("id", "nos")

catch.traits$NArea <- n.area$nos[match(catch.traits$id, n.area$id)]
```



## Bathymetric map of Sudan with ggplot and marmap
A nice, bathymetric map of Sudan with management areas overlaid. (Fig. 1 in MS)

March 2021: New code for making bathymetric map to include depth legend, north arrow and scale bar. 
```{r NOAA bathy data, echo=FALSE}
Bathy <- getNOAA.bathy(lon1 = 36.5, lon2 = 39,
                       lat1 = 18, lat2 = 22, resolution = 1)
```


```{r bathymap ggplot, echo=FALSE, warning=FALSE}
library(mapproj)
library(ggsn)

sudan<-readGEBCO.bathy("./sudan_bathymetry/sudan.nc")

MApoints1<-data.frame(lon=c(37.2, 37.5, 37.37, 37.5, 37.5, 37.8, 38.2), lat=c(21.7, 20.93, 20.3, 19.9, 19, 19.2, 18.5), area=c(1,2,3,4,5,6,7), anames=c("1. \nMarsas \nnorth of \nDungonab", "2. \nDungonab", "3. \nArakiai", "4. \nPort \nSudan", "5. \nSuakin", "6. \nSuakin \narchipelago", "7. Agig"))

cities <- data.frame(lon=c(37.333333, 37.21709967), lat=c(19.1, 19.600512), city=c("Suakin", "Port Sudan"))



#ctd <- data.frame(Longitude = c(37.5, 38, 38.5), Latitude = c(-47, -46.5, -46))

smap2 <- autoplot.bathy(sudan, geom=c("raster")) +
    #scale_fill_gradient2(low="dodgerblue4", mid="white", high="gray10") +
    #geom_point(data = ctd, aes(x = Longitude, y = Latitude), colour = 'black', size = 3, alpha = 1, shape = 15) +
  scale_fill_gradientn(colors = c("midnightblue", "deepskyblue3", "deepskyblue1", "cadetblue3", "cadetblue1", "darkseagreen1", "white", "gray10"),
                            values = scales::rescale(c(-2847, -500, -200, -100, -50, -10, 0, 1, 2010))) +
    geom_path(data=ManageAreas.f,colour="black", aes(x=long, y=lat, group=id)) +
    labs(y = "Latitude", x = "Longitude", fill = "Elevation") 
 
  smap3 <-   smap2 + north(ManageAreas.f, symbol=10,scale=0.2) +geom_text(data=MApoints1, hjust="left", size=3, aes(x=lon, y=lat, group=area, label=anames)) + geom_point(data=cities, size=2, colour="gray10", aes(x=lon, y=lat)) + geom_text(data=cities, label=cities$city, size=4,  hjust=1.15, vjust=0,  aes(x=lon, y=lat, group=city)) +  scalebar(ManageAreas.f, location="topright", dist = 50, dist_unit = "km", transform = TRUE, model = "WGS84") + theme(legend.position = c(0.9, 0.6))

smap3
ggsave("./figs/Fig1_bathymap2 sudan.tiff")  
  
  
#create world map
world <- map_data("world")
d <- data.frame(x1=c(36.5), x2=c(39), y1=c(18), y2=c(22.3))

regionmap <- ggplot() +
  geom_map(
    data = world, map = world,
    aes(long, lat, map_id = region),
    color = "black", fill = "lightgray", size = 0.1
  ) + coord_quickmap(xlim=c(20, 60), ylim=c(0, 40)) + geom_rect(data=d, mapping=aes(xmin=x1, xmax=x2, ymin=y1, ymax=y2), color="red", fill= NA, alpha=0.5) + theme_void() + theme(
  panel.background = element_rect(fill = "white",
                                colour = "white",
                                size = 0.5, linetype = "solid"))
       regionmap
    
#add regionmap as incert to area-map
png(filename = "./figs/Fig1_bathy_insert.png", width = 3600, height = 2600, res = 300)
# create a viewport for inset
# vp_inset width/height arguments set the size of the inset; x and y arguments set the position (from 0 to 1) of the left, top corner of the inset along each axis (i.e. not map coordinates as you have in your annotation custom). You can adjust these as you see fit.
vp_inset <- grid::viewport(width = 0.2, height = 0.2, x = 0.29, y = 0.252, just = c("left", "top"))
print(smap3)
print(regionmap, vp = vp_inset)
#while (!is.null(dev.list()))  dev.off()
 dev.off()
```


## Stations plotted on maps, pr survey
Faceted map plotting position of all catch stations for each of the three surveys. 
```{r station map, echo=FALSE}
library(patchwork)

MApoints<-data.frame(lon=c(37.2, 37.53, 37.5, 37.4, 37.3, 37.9, 38.2), lat=c(21.7, 20.92, 20.3, 19.9, 19, 19.3, 18.5), area=c(1,2,3,4,5,6,7), survey_m=c(1,1,1,1,1,1,1))

#ManageAreas.f$survey_m <- 1

world<- map_data("worldHires", c("Sudan", "Ethiopia")) 
world$survey_m<-c("Survey 1: Nov. 2012")
world2<-world
world2$survey_m<-c("Survey 2: May 2013")
world3<-world
world3$survey_m<-c("Survey 3: Nov. 2013")
world<-rbind(world, world2, world3)

colors <- brewer.pal(3, "Dark2")

s1.map <- ggplot(subset(catch, survey==2012901), aes(x=lon, y=lat)) + 
  geom_point(shape="+", size=2, colour= colors[1], aes(group=survey_m, colour= survey_m))  + 
  geom_path(data=ManageAreas.f,colour="dodgerblue3", aes(x=long, y=lat, group=id)) + 
  geom_polygon(data=world, colour="gray35", fill="gray85", aes(x=long, y=lat, group=survey_m))  + 
  coord_cartesian(xlim = c(36.58, 39), ylim=c(17.87, 22.5)) +
  theme_classic() + 
  geom_point(data=ps, size=2, colour="gray35", aes(x=x, y=y, group=survey_m)) + 
  geom_text(data=ps, label="PZU", size=3,  hjust=1, vjust=-1.2,  aes(x=x, y=y, group=survey_m)) + 
  geom_text(data=MApoints, aes(x=lon, y=lat, group=survey_m, label=area)) +
  theme(legend.position="none")  +
  ggsn::north(ManageAreas.f, symbol=10,scale=0.2, location="topright") +  
  ggsn::scalebar(ManageAreas.f, location="bottomleft", dist = 50, dist_unit = "km", transform = TRUE, model = "WGS84", st.size=3, nudge_y=-0.05) + 
  ggtitle("Survey 1: Nov. 2012")


s2.map <- ggplot(subset(catch, survey==2013002), aes(x=lon, y=lat)) + 
  geom_point(shape="+", size=2, colour= colors[2], aes(group=survey_m, colour= survey_m))  + 
  geom_path(data=ManageAreas.f,colour="dodgerblue3", aes(x=long, y=lat, group=id)) + 
  geom_polygon(data=world, colour="gray35", fill="gray85", aes(x=long, y=lat, group=survey_m))  + 
  coord_cartesian(xlim = c(36.58, 39), ylim=c(17.87, 22.5)) +
  theme_classic() + 
  geom_point(data=ps, size=2, colour="gray35", aes(x=x, y=y, group=survey_m)) + 
  geom_text(data=ps, label="PZU", size=3,  hjust=1, vjust=-1.2,  aes(x=x, y=y, group=survey_m)) + 
  geom_text(data=MApoints, aes(x=lon, y=lat, group=survey_m, label=area)) +
  theme(legend.position="none")  + 
  ggtitle("Survey 2: May 2013")


s3.map <- ggplot(subset(catch, survey==2013005), aes(x=lon, y=lat)) + 
  geom_point(shape="+", size=2, colour= colors[3], aes(group=survey_m, colour= survey_m))  + 
  geom_path(data=ManageAreas.f,colour="dodgerblue3", aes(x=long, y=lat, group=id)) + 
  geom_polygon(data=world, colour="gray35", fill="gray85", aes(x=long, y=lat, group=survey_m))  + 
  coord_cartesian(xlim = c(36.58, 39), ylim=c(17.87, 22.5)) +
  theme_classic() + 
  geom_point(data=ps, size=2, colour="gray35", aes(x=x, y=y, group=survey_m)) + 
  geom_text(data=ps, label="PZU", size=3,  hjust=1, vjust=-1.2,  aes(x=x, y=y, group=survey_m)) + 
  geom_text(data=MApoints, aes(x=lon, y=lat, group=survey_m, label=area)) +
  theme(legend.position="none") + 
  ggtitle("Survey 3: Nov. 2013")

s1.map + s2.map +s3.map


ggsave("./figs/Fig2_station_map.tiff", width=240, height=160, units="mm", dpi=400)
```


## Station information
### Station table
Table describing the sampling effort in each area pr survey, number of different gear types, max, min and average depth, number of traps with / without catches. 
```{r station table, echo=FALSE}
#' TABLE OF SAMPLING EFFORT PR. MANAGEMENT AREA
#' (new for resubmission to PlosOne)
#' --------------------------------------------

s <- unique(catch.unmod$survey)
a <- as.factor(1:7)
ay_info <- data.frame(survey=integer(), id=integer(), Ntraps=integer(), Nhl=integer(), NGn=integer(), TBhrs=double(), HLhrs=double(), GNhrs=double(), DepthAvg=double(), DepthSD=double(),DepthMax=double(), DepthMin=double()) 
cn <- colnames(ay_info)
# depth for TB only (GN are at the surface, and HL not measured)

for (i in 1:length(s)) { 
  y <- subset(catch.unmod, survey==s[i])
  for (j in 1: length(a)){
    ay_1 <- data.frame(survey=integer(), id=integer(), Ntraps=integer(), Nhl=integer(), NGn=integer(), TBhrs=double(), HLhrs=double(), GNhrs=double(), DepthAvg=double(), DepthSD=double(), DepthMax=double(), DepthMin=double())
    ya <- subset(y, id==a[j])
    ay_1 <- rbind(ay_1, c(
      as.integer(as.character(ya$survey[1])), 
      as.integer(as.character(ya$id[1])), 
      length(unique(subset(ya, gear=="TB")$station)),  
      length(unique(subset(ya, gear=="HL")$station)), 
      length(unique(subset(ya, gear=="GN")$station)), 
      sum(subset(ya, gear=="TB")[!duplicated(ya$station),]$Fhrs, na.rm=TRUE),  
      sum(subset(ya, gear=="HL")[!duplicated(ya$station),]$Fhrs, na.rm=TRUE), 
      sum(subset(ya, gear=="GN")[!duplicated(ya$station),]$Fhrs, na.rm=TRUE), 
      mean(subset(ya, gear=="TB")[!duplicated(ya$station),]$depth, na.rm=TRUE), 
      sd(subset(ya, gear=="TB")[!duplicated(ya$station),]$depth, na.rm=TRUE),
      max(subset(ya, gear=="TB")$depth, na.rm=TRUE), 
      min(subset(ya, gear=="TB")$depth, na.rm=TRUE)    ))
    colnames(ay_1) <- cn
    ay_info <- rbind(ay_info, ay_1)
    colnames(ay_info) <- cn
  }
}

formattable(ay_info)

write.csv2(ay_info, "./figs/Area_Station_table.csv")
```

#### Distance between stations
```{r station distance, echo=FALSE}
library(sf)

#### TRAPS
sts <- subset(catch.unmod, gear=="TB")[,c(1,30, 17, 13,14)]

# split by survey and area
dist_tbl <- data.frame(dist=double(), survey=integer(), area=integer())
surveys <- c(2012901, 2013002, 2013005)
areas <- c(1:7)

for (i in 1:3) {   
  for (j in 1:7) { 
    sts2 <- subset(sts, survey==surveys[i] & id ==areas[j])
    s_sf<- sts2 %>% 
      st_as_sf(coords = c("lon", "lat")) %>%
      st_set_crs(4326) #'4326' is same as WGS84
    dist2 <- as.data.frame(st_distance(s_sf))
    
    d2 <- data.frame(dist = c(t(dist2)))
    d2$survey <- surveys[i]
    d2$area <- areas[j]
    d2 <- subset(d2, dist!=0)
    
    dist_tbl <- rbind(dist_tbl, d2)
  }
}
#plot and facet_wrap by surveys

survey_names <- c(`2012901` = "Nov. 2012", `2013002` = "May 2013", `2013005` = "Nov. 2013" )

dist.plot <- ggplot(dist_tbl, aes(x=as.factor(area), y=dist/1000, group=as.factor(area))) + geom_boxplot() + facet_wrap(vars(survey), labeller = as_labeller(survey_names)) +ylab("Distance between stations (km)") +xlab("Management areas")
dist.plot

ggsave("./figs/Traps_station_distances.png")

# table of stats
dist_tbl %>% group_by(survey, area) %>% summarise( min=min(dist),max=max(dist), mean=mean(dist), median=median(dist))%>% write.csv2("./figs/disttable_traps.csv")



#### GILLNETS
sts <- subset(catch.unmod, gear=="GN")[,c(1,30, 17, 13,14)]

# split by survey and area
dist_tbl <- data.frame(dist=double(), survey=integer(), area=integer())
surveys <- c(2012901, 2013002, 2013005)
areas <- c(1:7)

for (i in 1:3) {   
  for (j in 1:7) { 
    sts2 <- subset(sts, survey==surveys[i] & id ==areas[j])
    if (nrow(sts2)>0) { 
      s_sf<- sts2 %>% 
        st_as_sf(coords = c("lon", "lat")) %>%
        st_set_crs(4326) #'4326' is same as WGS84
      dist2 <- as.data.frame(st_distance(s_sf))
      
      d2 <- data.frame(dist = c(t(dist2)))
      d2$survey <- surveys[i]
      d2$area <- areas[j]
      d2 <- subset(d2, dist!=0)
      
      dist_tbl <- rbind(dist_tbl, d2)
    }
  }
}
#plot and facet_wrap by surveys

survey_names <- c(`2012901` = "Nov. 2012", `2013002` = "May 2013", `2013005` = "Nov. 2013" )

dist.plot <- ggplot(dist_tbl, aes(x=as.factor(area), y=dist/1000, group=as.factor(area))) + geom_boxplot() + facet_wrap(vars(survey), labeller = as_labeller(survey_names)) +ylab("Distance between stations (km)") +xlab("Management areas")
dist.plot

ggsave("./figs/Gillnets_station_distances.png")

# table of stats
dist_tbl %>% group_by(survey, area) %>% summarise( min=min(dist),max=max(dist), mean=mean(dist), median=median(dist)) %>% write.csv2("./figs/disttable_nets.csv")
```



#### Species table
Number of fish (organized by family and species) caught by Gillnet or Traps for each survey, and in total across all surveys and gears. 

* (new table for revision 2020) *
```{r species tabel, echo=FALSE}

species.table <- subset(catch, Sci_name!="NO CATCH" & Sci_name!="No catch" & gear=="TB" | gear =="GN") %>% dplyr::group_by(Fam_name, Sci_name, survey, gear) %>% dplyr::summarise(No.individ=sum(as.integer(number), No.gear=n_distinct(ss)))

#number of species and families total
subset(catch, Sci_name!="NO CATCH" & Sci_name!="No catch" & gear=="TB" | gear =="GN") %>% summarise(families=n_distinct(Fam_name), species=n_distinct(Sci_name))

#number of species and families by gear
species.table %>% dplyr::group_by(gear) %>% dplyr::summarise(families=n_distinct(Fam_name), species=n_distinct(Sci_name))

gnsp <- subset(catch, Sci_name!="NO CATCH" & Sci_name!="No catch" &  gear =="GN") %>% dplyr::group_by(Fam_name, Sci_name) %>% dplyr::summarise(No.individ=sum(as.integer(number), No.gear=n_distinct(ss)))

species.table <- spread(species.table, gear, No.individ)

spt <- species.table[,2:5] %>%
  gather(variable, value, -(Sci_name:survey)) %>%
  unite(temp, survey, variable) %>%
  spread(temp, value)  %>%
  replace(is.na(.), 0) %>%
  rowwise() %>%
  #mutate(sum = rowSums(.[2:7]))
  dplyr::mutate(sum = sum(c_across("2012901_GN":"2013005_TB")))

spt$fam_name <- species.table$Fam_name[match(spt$Sci_name, species.table$Sci_name)] 
 
spt[,c(9,1:8)]%>%
  kable(format = "html", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 8)

write.csv2(spt, "./figs/species_catch_table.csv")


# similar table for number of traps/gillnets with catches of species

st2 <- subset(catch, Sci_name!="NO CATCH" & Sci_name!="No catch" & gear=="TB" | gear =="GN") %>% dplyr::group_by(Fam_name, Sci_name, survey, gear) %>% dplyr::summarise( No.gear=n_distinct(ss))

st2 <- spread(st2, gear, No.gear)

spt2 <- st2[,2:5] %>%
  gather(variable, value, -(Sci_name:survey)) %>%
  unite(temp, survey, variable) %>%
  spread(temp, value)  %>%
  replace(is.na(.), 0) %>%
  rowwise() %>%
  #mutate(sum = rowSums(.[2:7]))
  dplyr::mutate(sum = sum(c_across("2012901_GN":"2013005_TB")))

spt2$fam_name <- species.table$Fam_name[match(spt$Sci_name, species.table$Sci_name)] 
 
spt2[,c(9,1:8)]%>%
  kable(format = "html", escape = F) %>%
   kable_styling(bootstrap_options = c("striped", "hover", "condensed"), font_size = 8)

write.csv2(spt2, "./figs/species_catch_table_NoStations.csv")


```


***

### Number of set traps per depth
Box plot of depths at wich traps were set. I prefer this visualization of depth ranges of the traps, rather than a (boring) table. 
```{r traps per depth, echo=FALSE}

# New facet label names for survey variable
#survey.labs <- c("Nov.2012", "May.2013", "Nov.2013")
#names(survey.labs) <- c("Survey 1: Nov. 2012", "Survey 2: May 2013",  "Survey 3: Nov. 2013")

c2 <- catch %>% dplyr::group_by(ss) %>% dplyr::summarise(first(depth), first(gear), first(id), first(survey), first(survey_m))
colnames(c2) <- c("ss", "depth", "gear", "id", "survey", "survey_m")
c2$survey_m <- as.factor(c2$survey_m)



# function for number of observations 
give.n <- function(x){
  return(c(y = median(x)*0.7, label = length(x))) 
  # experiment with the multiplier to find the perfect position
}

dp <- ggplot(subset(c2, gear=="TB" & depth!=0), aes(as.factor(id), depth))

#dp <- dp +  geom_violin(scale="width", aes(fill=as.factor(id)), draw_quantiles = c(0.5)) + scale_y_reverse() +stat_summary(fun.data = give.n, geom = "text", fun.y = median) + labs(x="Management areas", y="Trap set depth (m)") + scale_fill_manual(name="Management area",values=sequential_hcl(n = 7, h = c(0, -100), c = c(80, NA, 40), l = c(53, 75), power = c(1, 1), rev = TRUE, register = ), guide=FALSE ) +theme_bw()  +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

dp <- dp +  geom_boxplot(scale="width", aes(), draw_quantiles = c(0.5)) + scale_y_reverse() + labs(x="Management areas", y="Trap set depth (m)")  +theme_bw()  +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

dp

ggsave("./figs/trap_depth.tiff", width=6, height=6)
ggsave("./figs/trap_depth.png", width=6, height=6)

#tiff(file="./figs/trap_area_depth.tiff", width=3000, height=1500, res=400, pointsize=10, compression=c("none"))
#dp
#dev.off()
```

####Test differneces in depths in each area between years and between areas

```{r  test trap depth, echo=FALSE}

c3 <- subset(catch, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))

#' test for normality
shapiro.test(c3$depth)

# significan difference, e.g null-hypothesis that data are normally distributed is rejected

#' Q-Q plots
ggplot(data = c3, mapping = aes(sample = depth,  fill = factor(id))) + qqplotr::stat_qq_band() + qqplotr::stat_qq_line() + qqplotr::stat_qq_point(size=0.2) + facet_wrap(~ id, scales="free") +  labs(x = "depth predicted", y = "depth Observed") + ggtitle("Q-Q plots depth")

#CONCLUSION: Depth is NOT normally distributed, so can use ANOVA for analysis of variance

# Use non-parametric Kruskal-Wallis test

#' 1 - test for difference between areas
kruskal.test(c3$depth, c3$id)
#significant difference

#' Post-Hoc tests of Kruskal - Wallis results
#library("PMCMR", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
PMCMR::posthoc.kruskal.nemenyi.test(c3$depth, c3$id, "Chisq")

#' significant difference between areas 1:5, 2:5, 5:6, 5:7


#' 2 - test for differences between areas and surveys
surv <- levels(as.factor(c3$survey))
for (i in 1:length(surv)){ 
  ci <- subset(c3, survey==surv[i])
  print(surv[i])
  print(kruskal.test(ci$depth, ci$id))
  print(PMCMR::posthoc.kruskal.nemenyi.test(ci$depth, ci$id, "Chisq"))
}

# significant differences between
# Nov. 2012 - between 1:5, 2:5, 5:6, 5:7 
# May 2013 - between 2:5
# Nov 2013 - Not significan K-W test and no significan pairwise differences. 

```
Depth data were not normally distributed and hence the difference in depth could only be analyzed using non-parametric Kruskal - Wallis rank sum test. 

Of the 63 survey - area comparisons, depth distributions were different between areas as follows:
Nov.2012 survey:
1:5, 2:5, 5:6 and 5:7  
May 2013 survey:
2:5

No significant differences for the Nov. 2013 survey



##### GAM model of trap depths
Fits a GAM model (using GAMLSS package) to the depth with area as explanatory variable and survey as a random factor. Use 'chooseDIst' function to test which distribution on the positive real line best fit the data. 
```{r GAM depths random survey, echo=FALSE}

# using the function chooseDist()
# fitting normal distribution model
#m1 <- gamlss(depth~factor(id)+factor(survey),  family=NO, data=c3)
m1 <- gamlss(depth~factor(id)+random(factor(survey)),  family=NO, data=c3)

# choose a distribution on the positive real line 
t1 <- chooseDist(m1, type="realplus")

# the GAIC's
t1

# only 'exGAUS' and 'PARETO2' and 'PARETO2o' were able to run, with 'exGAUS' giving the best GAIG fit. 

# ordering according to  BIC
getOrder(t1,3)

#updating the model with the best distribution 'EXGAUS'
fm<-update(m1, family=names(getOrder(t1,3)[1]))
summary(fm)
fm
AIC(fm)
drop1(fm)
#plot(fm)
# Significant factors: areas 3, 4, 5, and 6 

histDist(depth,family="exGAUS", ymax=0.05, nbins=20, data=c3)

```

The GAMLSSS model picked 'exGAUS' as the best distribution to use in the model, which seems sensible from plotting the model over historgram of the depth. 

Using the 'exGAUS' model areas 3, 4, 5 and 6 come out as significant factors, meaning the depth in these areas are significantly different from depths in other areas. The 'drop1' function showed that surveys as a random effect were a significant factor in the model. 

##### Combination of GAMLSS model and Kruskal - Wallis
The GAMLSS model shows that there are signicant effects of area 3, 4, 5, and 6 on the depth distribution, and the K-W test shows significant differences for the Nov. 2012 survey between area 1:5, 2:5, 5:6, 5:7 and for the May 2013 survey for areas 2:4, which is in corrspondence with the GAM results. 


*** 

### Duration of trap sets 

#### Mean, min & max hrs. of fishing
```{r hrs of fishing, echo=FALSE}
subset(catch, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), fhrs=first(Fhrs)) %>% 
  dplyr::group_by(id) %>%
  dplyr::summarise( maxhrs=max(fhrs), minhrs=min(fhrs), meanhrs=mean(fhrs)) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)

#overall mean Fhrs
summary(subset(catch, gear=="TB") %>% 
  group_by(ss) %>% 
  dplyr::summarise(id=first(id), fhrs=first(Fhrs)))

```


### Fishing hours (traps) by survey and area
Boxplot of median with mean values plotted as red circle. 
```{r duration traps, echo=FALSE}

c3 <- subset(catch, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
c3$survey_m <- as.factor(c3$survey_m)


duration.plot <- ggplot(c3, aes(as.factor(id), Fhrs))

duration.plot <-  duration.plot +  geom_boxplot() + stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red") + labs(x="Management areas", y="Hours fishing (traps)")  +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May.2013",
      "Survey 3: Nov. 2013" = "Nov.2013")))

duration.plot
#a1 <- subset(c3, id==1)
#ggplot(a1, aes(as.factor(id), Fhrs)) + geom_boxplot()+facet_wrap(~as.factor(survey_m))

#by(a1$Fhrs, a1$survey, summary)
```
The average trap soak-time (fishing hours) across all surveys and areas was 17.984 hrs with a median of 16.15, but the November 2012 survey had more varied and higher soak times than the May 2013 and Nov. 2013. 

#### Test differences in soak times (traps) K-W test
```{r  test Fhrs traps, echo=FALSE}
#' test for normality
shapiro.test(c3$Fhrs)

#' Q-Q plots
ggplot(data = c3, mapping = aes(sample = Fhrs,  fill = factor(id))) + qqplotr::stat_qq_band() + qqplotr::stat_qq_line() + qqplotr::stat_qq_point(size=0.2) + facet_wrap(~ id, scales="free") +  labs(x = "Fhrs predicted", y = "Fhrs Observed") + ggtitle("Q-Q plots depth")

#CONCLUSION: Fishing hours (soak time) is NOT normally distributed, so can use ANOVA for analysis of variance

# Use non-parametric Kruskal-Wallis test

#' 1 - test for difference between areas
kruskal.test(c3$Fhrs, c3$id)
#significant difference

#' Post-Hoc tests of Kruskal - Wallis results
#library("PMCMR", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
PMCMR::posthoc.kruskal.nemenyi.test(c3$Fhrs, c3$id, "Chisq")

#' significant difference between areas 7:1, 7:2, 6:2, 7:4, 6:4, 7:5, 


#' 2 - test for differences between areas and surveys
surv <- levels(as.factor(c3$survey))
for (i in 1:length(surv)){ 
  ci <- subset(c3, survey==surv[i])
  print(surv[i])
  print(kruskal.test(ci$Fhrs, ci$id))
  print(PMCMR::posthoc.kruskal.nemenyi.test(ci$Fhrs, ci$id, "Chisq"))
}

# Significant differences between:
# Nov 2012- between: 1:7, 7:2, 6:2, 7:3, , 7:4, 6:4, 5:6
# May 2013 - between: 2:6, 2:7, 3:6, 3:7, 4:6, 4:7
# Nov 2013 - between: 1:6, 2:6, 2:7

```
Of the 63 area- survey combinations 16 were significantly different (Kruskal Wallis rank sum test with Nemenyi post-hoc test, p<0.05). In Nov. 2012 area 1 was significantly different from 7, area 2 from 6 and7, area 3:7, area 4 vs 6 and 7, area 5 vs 6. In May 2013 area 2 was significantly different from 6 and 7, area 3 from 6 and 7, and area 4 from 6 and 7. In Nov 2013 area 1 was significantly different from area 6, while area 2 was significantly different from area 6 and 7.  

#### GAMLSS model of soak times
```{r GAM soak time, echo=FALSE}
#m1 <- gamlss(Fhrs~factor(id)+factor(survey),  family=NO, data=c3)
m1 <- gamlss(Fhrs~factor(id)+random(factor(survey)),  family=NO, data=c3)
t1 <- chooseDist(m1, type="realplus")
getOrder(t1,3)
fm<-update(m1, family=names(getOrder(t1,3)[1]))
#summary(fm)

m2 <- gamlss(Fhrs~factor(id)+factor(survey),  family=NO, data=c3)
t2 <- chooseDist(m2, type="realplus")
getOrder(t2,3)
fm2<-update(m2, family=names(getOrder(t1,3)[1]))


AIC(fm, fm2)
#fm2 - with survey as random factor has lower AIC 

summary(fm2)
fm2
drop1(fm2)

histDist(Fhrs,family="BCPEo", ymax=0.05, nbins=60, data=c3)

```

GAMLSS found the 'BCPEo' to give the best fit to the 'Fhrs' data (see histogram plot).

Using the 'BCPEo' distribution a model of Fhrs by area (as factor) and survey as an ordinary factor showed that all surveys  and areas had a significant effect on the soak time for traps, meaning that soak time varied siginificantly between the areas & surveys. 


### Duration and catch rates of gill-net sets
```{r gillnet set time, echo=FALSE}

c33 <- subset(catch, gear=="GN") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
c33$survey_m <- as.factor(c33$survey_m)


#duration.plot.gn <- ggplot(c33, aes(id, Fhrs))

#duration.plot.gn <-  duration.plot.gn +  geom_point() + stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red") + labs( x="Management areas", y="Hours fishing (gillnets)")  +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

duration.plot.gn <- ggplot(c33, aes(as.factor(id), Fhrs))

duration.plot.gn <- duration.plot.gn  + geom_boxplot()  + stat_summary(fun.y=mean, geom="point", shape=20, size=3, color="red", fill="red") + labs( x="Management areas", y="Hours fishing (gillnets)")  +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May.2013",
      "Survey 3: Nov. 2013" = "Nov.2013")))

duration.plot.gn

# catch rates for gillnets
cpue.gn <- subset(catch.cpue, gear=="GN") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), CPUEw=sum(CPUEw), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
cpue.gn$survey_m <- as.factor(cpue.gn$survey_m)

ca.plot2<-ggplot(cpue.gn, aes(as.factor(id), CPUEw))


ca.plot2 <- ca.plot2 + geom_boxplot()+ labs( x="Management areas", y="CPUE kg/hour fishing (gillnets)") +theme_bw() +facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May.2013",
      "Survey 3: Nov. 2013" = "Nov.2013")))
ca.plot2



#(duration.plot.gn | ca.plot2) + plot_annotation(tag_levels = 'A') & 
 # theme(plot.tag = element_text(size = 10)) 

```
Fishing hours for traps was significantly affected by areas (except area 3 which had a very large variability), however, the number of gillnet sets was very low pr area and survey. 


```{r gillnet fishing hours GAM, echo=FALSE, warnings=FALSE}
m1 <- gamlss(Fhrs~factor(id)+random(factor(survey)),  family=NO, data=c33)
t1 <- chooseDist(m1, type="realplus")
getOrder(t1,3)
fm<-update(m1, family=names(getOrder(t1,3)[1]))
#summary(fm)

m2 <- gamlss(Fhrs~factor(id)+factor(survey),  family=NO, data=c33)
t2 <- chooseDist(m2, type="realplus")
getOrder(t2,3)
fm2<-update(m2, family=names(getOrder(t1,3)[1]))


AIC(fm, fm2)
#fm - with survey as random factor has much, much lower AIC 

summary(fm)
drop1(fm)

histDist(Fhrs,family="BCPE", ymax=0.05, nbins=60, data=c3)

```

Both area and survey were found to be significan variables for explaining fishing hours of gillnets. when the smoothing function was dropped ('drop' function). 

*** 

## Analysis of catches by traits and other factors

### Catch rates pr area & survey
Must aggregate data per station
```{r CPUE traps area, echo=FALSE}

cpue.tr.st <- subset(catch.cpue, gear=="TB") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), CPUEw=sum(CPUEw), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), survey_m=first(survey_m))
cpue.tr.st$survey_m <- as.factor(cpue.tr.st$survey_m)

ca.plot<-ggplot(subset(cpue.tr.st,  depth!=0), aes(as.factor(id), CPUEw))


#ca.plot <- ca.plot + geom_violin(scale="width", aes(fill=as.factor(id)), draw_quantiles = c(0.5))  + labs(x="Management areas", y="CPUE kg/hour fishing (traps") + scale_fill_manual(name="Management area",values=sequential_hcl(n = 7, h = c(0, -100), c = c(80, NA, 40), l = c(53, 75), power = c(1, 1), rev = TRUE, register = ), guide=FALSE ) +theme_bw()+facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

ca.plot <- ca.plot + geom_boxplot(scale="width", aes( draw_quantiles = c(0.5)))  + labs(x="Management areas", y="CPUE kg/hour fishing (traps") + scale_fill_manual(name="Management area",values=sequential_hcl(n = 7, h = c(0, -100), c = c(80, NA, 40), l = c(53, 75), power = c(1, 1), rev = TRUE, register = ), guide=FALSE ) +theme_bw()+facet_wrap(~survey_m, labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",      "Survey 2: May 2013" = "May.2013",      "Survey 3: Nov. 2013" = "Nov.2013")))

ca.plot

#tiff(file="./figs/catch_rates_traps_area_survey.tiff", width=3000, height=2000, res=400, pointsize=10, compression=c("none"))
#ca.plot
#dev.off()
```


## Statistical analysis CPUE catches
### Testing for normality of CPUEw of trap catches
Shapiro test for normality and Q-Q plots shows that data is non-normal and zero-inflated. 

```{r normality test, echo=FALSE}

#' test for normality
shapiro.test(cpue.tr.st$CPUEw)

#' Q-Q plots
library("qqplotr")
gg <- ggplot(data = cpue.tr.st, mapping = aes(sample = CPUEw,  fill = factor(id))) + stat_qq_band() + stat_qq_line() + stat_qq_point(size=0.2) + facet_wrap(~ id, scales="free") +  labs(x = "CPUEw predicted", y = "CPUEw Observed") + ggtitle("Q-Q plots CPUEw")
gg
```
### Test for difference in CPUEw of traps between areas (non-parametric test)
Both CPUEw  is not significantly different between the areas, 

Significant difference for CPUEW between Nov 2013 survey and the Nov 2012 and May 2013 surveys, but not between the Nov12 and May13 surveys

```{r nonpara ANOVA, echo=FALSE, eval=FALSE}
#### NOT RUN BECAUSE ZERO-ADJUSTED GAM MODEL IS BETTER!

#' 1 - test for difference between areas
kruskal.test(cpue.tr.st$CPUEw, cpue.tr.st$id)

#' Post-Hoc tests of Kruskal - Wallis results
library("PMCMR", lib.loc="/Library/Frameworks/R.framework/Versions/3.5/Resources/library")
posthoc.kruskal.nemenyi.test(cpue.tr.st$CPUEw, cpue.tr.st$id, "Chisq")
#' no significant difference in CPUE

#' 2 test for differences between surveys
kruskal.test(cpue.tr.st$CPUEw, cpue.tr.st$survey)

posthoc.kruskal.nemenyi.test(cpue.tr.st$CPUEw, cpue.tr.st$survey, "Chisq")

```

### Zero-inflated GAM model 
This method is more appropriate than the Kruskal-Wallis approach above as it evaluates the effects of all factors at the same time, instead of evaluating the effects of area separate from survey. 

First, developed a model for CPUE (weight and numbers) including depth, area, survey and gear (only traps and gillnets), which performed better than a simpler model excluding gear. 

Also tested models where survey was included as a random factor (using two different approaches: Â´randomÂ´and Â´reÂ´), although this excludes evaluation of the potential significant effects of the surveys on the results. 

Tested models for both CPUE by weight (CPUEw) and CPUE by numbers (CPUEn). 

Model performance were compared based on AIC. 

Model specified:  
CPUEw models:  
* mod1<-gamlss(CPUEw~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA,data=cpue.st)  
* mod2<-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st) 
* mod3<-gamlss(CPUEw~depth+factor(id)+factor(gear)+re(random=~1|survey),family=ZAGA, data=cpue.st)
* mod4 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAGA, data=cpue.st)  
* mod5 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAIG, data=cpue.st)  
* mod6 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+factor(survey),nu.fo=~depth+factor(id)+factor(gear)+factor(survey), family=ZAGA, data=cpue.st) 

Weight with Fhrs as dependent models:
* modA1<-gamlss(weight~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st)  
* modA2 <- gamlss(weight~depth+Fhrs+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st)  

Numbers with Fhrs as dependent model:
* modA4 <- gamlss(number~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st)  


CPUEn models:
* modA3<-gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st)  
* modA5<-gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st)  
* modA6 <- gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st)  
* modA7 <- gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+factor(survey),family=ZAGA, data=cpue.st)



```{r zero-infl model, echo=FALSE}
cpue.st <- subset(catch.cpue, gear=="TB" | gear=="GN") %>% 
  dplyr::group_by(ss) %>% 
  dplyr::summarise(id=first(id), Fhrs=first(Fhrs), CPUEw=sum(CPUEw), CPUEn=sum(CPUEn), weight=sum(weight), number=sum(number), depth=first(depth), gear=first(gear), id=first(id), survey=first(survey), gear=first(gear), survey_m=first(survey_m))
cpue.st$survey_m <- as.factor(cpue.st$survey_m)

# Testing different Zero-Inflated models for the data:
# CPUEw - GAMLSS ZAGA model incluing survey, area, depth & gear 
mod1<-gamlss(CPUEw~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

# Model with survey as random effect
mod2<-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st) 

# model with survey as random effect, using re() function from lme
library(nlme)
mod3<-gamlss(CPUEw~depth+factor(id)+factor(gear)+re(random=~1|survey),family=ZAGA, data=cpue.st) 

# specifcying nu.fo
mod4 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAGA, data=cpue.st) 

#  ZAIG model 
mod5 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey)), family=ZAIG, data=cpue.st) 

# mod6 survey as normal factor, nu function specified
mod6 <-gamlss(CPUEw~depth+factor(id)+factor(gear)+factor(survey),nu.fo=~depth+factor(id)+factor(gear)+factor(survey), family=ZAGA, data=cpue.st) 

AIC(mod1, mod2, mod3, mod4, mod5)

#alternative model of weight with Fhrs as factor
modA1<-gamlss(weight~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

# modA1 with survey as random factor
modA2 <- gamlss(weight~depth+Fhrs+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st) 

#alt model of numbers with CPUEn
modA3<-gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

# modA3 with number of catch with Fhrs as factor
modA4 <- gamlss(number~depth+Fhrs+factor(id)+factor(survey)+factor(gear),family=ZAGA, data=cpue.st) 

#modA5 with CPUEn and survey as a random factor
modA5<-gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),family=ZAGA, data=cpue.st) 


#modA6 - modA5 with nu function specified
modA6 <- gamlss(CPUEn~depth+factor(id)+random(factor(survey))+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+random(factor(survey)),family=ZAGA, data=cpue.st)

#mod A7 with survey as normal factor, nu function specified
modA7 <- gamlss(CPUEn~depth+factor(id)+factor(survey)+factor(gear),nu.fo=~depth+factor(id)+factor(gear)+factor(survey),family=ZAGA, data=cpue.st)

AIC(mod1, mod2, mod3, mod4, mod6, modA1, modA2, modA3, modA4, modA5, modA6, modA7)

# Best  model for catch weight is model 6 (CPUEw) while model A7 is the best for numbers (CPUEn)
# the CPUEn (Numbers model) has a much lower AIC than the CPUEw model
summary(mod6)
drop1(mod6)
plot(mod6)
wp(mod6, ylim.all=2); title("model 4 - using 'random(), nu-function specified'")

summary(modA7)
plot(modA7)
drop1(modA7)
wp(modA7, ylim.all=2); title("model 4 - using 'random(), nu-function specified'")

#plotting ZAGA distribution & histogram of CPUEw
plotZAGA(mu=fitted(mod6, "mu")[1], sigma=fitted(mod2, "sigma")[1],nu=fitted(mod2, "nu")[1], main="(a)", ylab="density")

#plotting ZAGA distribution of modA6 (CPUEn)
plotZAGA(mu=fitted(modA7, "mu")[1], sigma=fitted(mod2, "sigma")[1],nu=fitted(mod2, "nu")[1], main="(a)", ylab="density")

#hist(cpue.st$CPUEw, breaks=50)

mod6
modA7

AIC(mod1, mod2, mod3, mod4, mod6, modA1, modA2, modA3, modA4, modA5, modA6, modA7) %>%
  kable(format = "html", escape = F) %>%
  kable_styling("striped", full_width = F)
```
##### Choice of models
* CPUEn models had lower AIC than CPUEw 
* models with nu function specified performed better (lower AIC) than models without (for both CPUEw and CPUEn)  
* model with survey as a random factor performed worse (higher AIC) than models with survey as an ordinary factor (for both CPUEw and CPUEn, as well as models with nu function defined)  



##### Model for weight of catch (CPUEw) 
* The best fitting (lowest AIC) model was 'mod6' where survey was an ordinary factor and the nu-function was defined. 
* Area and gear were the only two variables found to be significant for the model when the smoothing function was dropped ('drop1' function)

* For mod6 'gear' and 'survey' (Nov 2013) were significant factors. (intercept and depth were not)

##### Model for number of catch (CPUEn)
* The best fitting (lowest AIC) model was 'modA7' where survey was an ordinary factor and the nu-function specified. 

* For modA7 the variables depth, area 1, area 2, area 5, surveys (all) and gear were significant factors.
* All variable (depth, area, survey and gear) were found to be significant variables in the model when the smoothing function was dropped ('drop1' function)


#### GAM model CPUE - traps only
Statistical analysis of plot of trap catch rates
```{r GAM Traps only, echo=FALSE}

c22 <- subset(cpue.st, gear=="TB")

# Model of CPUEw with survey as random effect
mod22<-gamlss(CPUEw~depth+factor(id)+random(factor(survey)),family=ZAGA, data=c22) 

#model of CPUEw with survey as factor
mod33 <- gamlss(CPUEw~depth+factor(id)+factor(survey),family=ZAGA, data=c22) 

#model of CPUEn with survey as random factor
mod44 <-gamlss(CPUEn~depth+factor(id)+random(factor(survey)),family=ZAGA, data=c22) 

#model of CPUEn with survey as factor
mod55 <- gamlss(CPUEn~depth+factor(id)+factor(survey),family=ZAGA, data=c22) 


AIC(mod22, mod33, mod44, mod55)
#mod55 had the lowest AIC
summary(mod55)
drop1(mod55)
mod55

```

The CPUEn models had better fit than the CPUEw models. 

For the model (mod55) of CPUEn with survey as an ordniary factor both area and survey were significant variable (when excluding the smoothing function), with all surveys and areas 1, 2 and 5 being significant factors in the model 


*** 

#### Bottom depth traps and gillnets
```{r freqplot trap and gillnet depth, echo=FALSE}

ggplot(cpue.st, aes(depth, colour = gear)) +  geom_freqpoly(binwidth = 5) +
  labs(title = "Bottom depth of trap and gill-net stations",
              subtitle = "i.e. fishing depth for traps, while gillnets were floating at the surface and fishing at 0-m depth") 

t.test(subset(cpue.st, gear=="TB")$depth, (subset(cpue.st, gear=="GN")$depth))

```

Depth was, however, not a significant factor in any of the four models developed for the trap CPUE, by weight or numbers. The depth distribution of bottom depth at the trap and gillnet stations (Gillnet fishing depth was at the surface, while trap fishing depth = bottom depth) were significantly different (t-test, p<0.05, df=67.9 -  see also frequncy plot above). Therefore, the models including both gear types led to a wider span and a more diverse distribution of the depths than for the traps-only data set. 

***

### Combine trap and gillnet duration + CPUE plots

```{r combined trap and gillnet plot, echo=FALSE}

(duration.plot + ca.plot)/(duration.plot.gn | ca.plot2) + plot_annotation(tag_levels = 'A') &   theme(plot.tag = element_text(size = 10)) +theme_minimal()

ggsave("./figs/Fig3_traps_nets_4_panel.png")
ggsave("./figs/Fig3_traps_nets_4_panel.tiff")


```


*** 

### CPUE by gear type  - by family and trophic group (gearplot)
Only for gillnets and traps and stations with catches (excluding no-catch)

#### TRAP CATCHES by depth bins (0-30m and >30m)

Split CPUEw by depth ranges (0-30m and >30m) for the trap catches. Gillnets were all taken at the surface so belong in the upper depth range.
```{r gearplot by depth, echo=FALSE, warning=FALSE}

c4 <- subset(catch.traits, TGShort!="NA" & (gear=="TB" | gear=="GN") & CPUEw>0)

############
# Depth range 0 - 30m

c41 <- subset(c4, (depth<=30 & gear=="TB"))
c42 <- subset(c4, (depth>30 & gear=="TB"))
c411 <- subset (c4, gear=="GN")
c41$Drng <- c("<30m")
c411$Drng <- c("<30m")
c42$Drng <- c(">30m")

c43 <- rbind(c41,c411, c42)


gear.plot.dr <- c43 %>%  mutate(FamGroup2 = fct_relevel(FamGroup2,  "Other Spp", "Serranidae","Scombridae","Lutjanidae", "Lethrinidae", "Chirocentridae", "Carcharhinidae", "Carangidae",  "Acanthuridae")) %>%
 ggplot( aes(FamGroup2, fill=Drng)) + geom_bar(binwidt=0.2, aes( weight=CPUEw)) +theme_bw() + facet_grid(vars(gear), vars(survey_m), labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May 2013",
      "Survey 3: Nov. 2013" = "Nov.2013"), gear=c("GN" ="Gillnet", "TB" ="Trap"))) + coord_flip() +xlab("") + ylab("kg/hour fishing (cumulative)")  + guides(fill=guide_legend(title="Survey")) + theme(legend.position = "none") + guides(fill=FALSE) + scale_fill_manual(values=c("seagreen3", "dodgerblue4"))
gear.plot.dr
#ggsave("./figs/gearplot_species.tiff")


# by trophic group
gear.plot2.dr <- ggplot(c43, aes(TGShort, fill=Drng)) + geom_bar(binwidt=0.2, aes( weight=CPUEw)) +theme_bw() + facet_grid(vars(gear), vars(survey_m), labeller=labeller(survey_m=c("Survey 1: Nov. 2012" = "Nov.2012",
      "Survey 2: May 2013" = "May 2013",
      "Survey 3: Nov. 2013" = "Nov.2013"), gear=c("GN" ="Gillnet", "TB" ="Trap"))) + coord_flip() +xlab("") + ylab("kg/hour fishing (cumulative)")  + guides(fill=guide_legend(title="Survey")) + theme(legend.position = "none") + guides(fill=FALSE) + scale_fill_manual(values=c("seagreen3", "dodgerblue4"))
gear.plot2.dr
#ggsave("./figs/gearplot_trophic_group.tiff")


# Combine plots in patchwork 
pw2 <- gear.plot2.dr / gear.plot.dr + plot_layout(guides = "keep") + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 10)) & 
  theme(text = element_text(size=5)) +theme(axis.text.y = element_text(size=8))  +theme_minimal() + theme(panel.border = element_rect(linetype = "solid", fill = NA))
pw2  


```



### Multivariate analysis of catch composition
PCA analysis was carried out to explore the variability in the catch data (CPUE-by-weight) in relation to:
- survey
- gear
- area
- Trophic group


PCA was carried out on average catches (CPUE) per survey and area (needed to create a M*N matrix - cannot have uneven number of observations per group).  

#### PCA Gillnets and traps, no depth bins
```{r PCA gillnets trap CPUEw, echo=FALSE, warning=FALSE}

# By trophic group 
# CPUEw
c5 <- subset(c4, CPUEw>0)[,c(1,16, 30, 24, 39)]
#c5 <- subset(c43, CPUEw>0)[,c(1,16, 30, 24, 39, 43)]
c5$index <- paste(c5$gear, c5$survey, c5$id, sep="_")

cc5 <- c5[,c(6,4,5)] %>%
#cc5 <- c5[,c(6,4,5,7)] %>%
  group_by(index, TGShort) %>%
  summarise(CPUEw=mean(CPUEw))%>%
  pivot_wider(names_from = TGShort, values_from = CPUEw, values_fill = list(CPUEw = 0)) 
cc5<-as.data.frame(cc5)
rownames(cc5) <- cc5$index

cc5$index <- NULL

df_pca <- prcomp(cc5)

plot(df_pca$x[,1], df_pca$x[,2])

df_out <- as.data.frame(df_pca$x)
df_out$gear <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 1 )
df_out$survey <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 2 )
df_out$area <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 3 )
#df_out$depth <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 4 )
head(df_out)

library(grid) 
library(gridExtra)

percentage <- round(df_pca$sdev / sum(df_pca$sdev) * 100, 2)
percentage <- paste( colnames(df_out), "(", paste( as.character(percentage), "%", ")", sep="") )

p<-ggplot(df_out,aes(x=PC1,y=PC2,color=gear, label=area, shape = factor(survey)))
p<-p +
  geom_point() + 
  #geom_text(size=3,  nudge_x = 0.15) + 
  xlab(percentage[1]) + 
  ylab(percentage[2]) + 
  scale_colour_discrete(name  ="Gear",
                            breaks=c("GN", "TB"),
                            labels=c("Gillnet", "Traps")) +
      scale_shape_discrete(name  ="Survey",
                           breaks=c("2012901", "2013002", "2013005"),
                           labels=c("Nov.2012", "May 2013", "Nov. 2013")) +
  theme_bw()
  

df_out_r <- as.data.frame(df_pca$rotation)
df_out_r$Trophic_Group <- row.names(df_out_r)

df_out_r

p2<-ggplot(df_out_r,aes(x=PC1,y=PC2,label=Trophic_Group ))
p2<-p2+ geom_text(size=3,position=position_jitter(width=0.2,height=0.2)) +  expand_limits(x = c(-0.15, 1.12), y=c(-1.12, 0.12)) +
  xlab(percentage[1]) + 
  ylab(percentage[2])+ theme_bw() + theme(legend.position = "none")

pw3 <- p / p2
pw3

#ggsave("./figs/PCA_catchcomp_weight.tiff", width=6, height=6)
#ggsave("./figs/PCA_catchcomp_weight.png", width=6, height=6)
```

#### PCA of TRAP catches split in depth categories (<30m and >30m)
(gillnets were only at the surface)

```{r PCA traps by depth, echo=FALSE, warning=FALSE}
c5 <- subset(c43, (CPUEw>0 & gear=="TB"))[,c(1,16, 30, 24, 39, 43)]
c5$index <- paste(c5$gear, c5$survey, c5$id, c5$Drng, sep="_")


cc5 <- c5[,c(6,4,5,7)] %>%
  group_by(index, TGShort) %>%
  summarise(CPUEw=mean(CPUEw))%>%
  pivot_wider(names_from = TGShort, values_from = CPUEw, values_fill = list(CPUEw = 0)) 
cc5<-as.data.frame(cc5)
rownames(cc5) <- cc5$index

cc5$index <- NULL

df_pca <- prcomp(cc5)

plot(df_pca$x[,1], df_pca$x[,2])

df_out <- as.data.frame(df_pca$x)
#df_out$gear <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 1 )
df_out$survey <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 2 )
df_out$area <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 3 )
df_out$depth <- sapply( strsplit(as.character(row.names(cc5)), "_"), "[[", 4 )
head(df_out)

library(grid) 
library(gridExtra)

percentage <- round(df_pca$sdev / sum(df_pca$sdev) * 100, 2)
percentage <- paste( colnames(df_out), "(", paste( as.character(percentage), "%", ")", sep="") )

p.d<-ggplot(df_out,aes(x=PC1,y=PC2,color=depth, label=area, shape = factor(survey)))
p.d<-p.d +
  geom_point() + 
  #geom_text(size=3,  nudge_x = 0.15) + 
  xlab(percentage[1]) + 
  ylab(percentage[2]) + 
  scale_colour_manual(name  ="Depth range",
                            breaks=c("<30m", ">30m"),
                            labels=c("Shallow (<30m)", "Deep (>30m)"), 
                            values=c("seagreen3", "dodgerblue4")) +
      scale_shape_discrete(guide=FALSE, name  ="Survey",
                           breaks=c("2012901", "2013002", "2013005"),
                           labels=c("Nov.2012", "May 2013", "Nov. 2013")) +
  theme_bw()
  

df_out_r <- as.data.frame(df_pca$rotation)
df_out_r$Trophic_Group <- row.names(df_out_r)

df_out_r

p2.d<-ggplot(df_out_r,aes(x=PC1,y=PC2,label=Trophic_Group ))
p2.d<-p2.d+ geom_text(size=3,position=position_jitter(width=0.2,height=0.25)) +  expand_limits(x = c(-0.17, 1.12), y=c(-1.12, 0.12)) +
  xlab(percentage[1]) + 
  ylab(percentage[2])+ theme_bw() + theme(legend.position = "none")

pw3.d <- p.d / p2.d
pw3.d

```



##### Combine gearplot and PCA
```{r gearplot pca, echo=FALSE}
#pw2 | pw3 

(gear.plot2.dr +gear.plot.dr) / (p + p2) / (p.d +p2.d) + plot_annotation(tag_levels = 'A') & 
  theme(plot.tag = element_text(size = 9))

#gear.plot2| pw3 

ggsave("./figs/Fig4_gearplot PCA.tiff", width=12, height=10)
ggsave("./figs/Fig4_gearplot PCA.png", width=12, height=10)
```
In Figure 4 panels A and B clearly show how the catch composition differed between traps and gillnets, both in relation to trophic groups and main fish families caught.  Carinvores were caught in similar quantities by both the traps and gillnets, coralivores only in traps (but in very low quantities) invertivores mainly in traps, planktivores and herbivores mainly in gillnets.  

Catch composition by families (Figure 4 panel A and B) showed clear differences in the species selectivity of  the gear types. 

Catch composition of traps showed some differences by depth range (<30m or > 30m), for the plantivores trophic group and Acunthuridae and Carangidae families that were only caught at shallow depths, while no trophic groups or families were uniquely caught at depths greater than 30m. 


PCA of catch weight and numbers (CPUEw and CPUEw) by trophic group  gave similar results and showed how trap and gillnet catches differed. The following analysis therefore focused solely on PCA by CPUEw.  

In the PCA analysis of both gillnet and traps (Figure 4, panel C and D). The first two principal components explained 88% of the variation. 
A large gillnet catch of Planktivores (56.69 kg gillnet catch of Naso hexacanthus in area 2 during the Nov. 2013 survey) drove the variability along PC1. PC2 was driven by high  catches of carnivores  during the November 2013 survey d. Catches of coralivores, invertivores and herbivores contributed little to the variability in either of the two first PCs (but these were caught in low quantities in just a few surveys and areas).  

The PCA analysis of the trap catches (Figure 4, panel E and F) the first two PCs explained 67.9% of the variability with PC1 and PC2 contributing fairly equally (35.9% and 32% respectively). Catches of carnivores and invertivores drove the variability along PC1 while a 10.14kg catch of planktivores (Naso hexacanthus) in area 5 in May 2013 in shallow waters  drove the variability along PC2. Apart from the May.2013 point no areas showed particular differences between deep and shallow areas. 
  
Trap catches were dominated by herbivores, gillnet catches by carnivores, while gillnet catches in area 2 during the Nov. 2013 survey had very high catches of planktivores compared to other gears, surveys and areas. Trap catches did not show marked difference by depth category, except for Area 5 during the May 2013 survey where there were (relatively) large catches of planktivores. 


However, this is still descriptive. Need to evaluate the differences statistically. Will use GAM model.   
(This also allows to use data on station level, not just average catches per area/survey needed to construct a matrix necessary for PCA)


```{r GAM model catch comp, echo=FALSE, warnings=FALSE}

#CPUEw data only as the catch figure only looks at catch weight.
#c4$gear <- as.factor(c4$gear)
#c4$TGShort <- as.factor(c4$TGShort)


m1 <- gamlss(CPUEw~factor(TGShort)+factor(survey)+factor(gear), family=NO, data=na.omit(subset(c4, CPUEw>0)))

t1 <- chooseDist(m1, type="realplus")
getOrder(t1,3)
cmod1<-update(m1, family=names(getOrder(t1,3)[1]))

summary(cmod1)
drop1(cmod1)

histDist(CPUEw,family="GIG", ymax=0.05, nbins=20, data=subset(c4, CPUEw>0))


```
Gear and trophic groups were significant variables in the model when the smoothing funciton was dropped. In the full model gears, the Nov. 2012 and Nov. 2005 surveys as well as the carnivores (intercept), coralivors, herbivores and invertivores were all significant factors affecting the catch rates (CPUEw) in the GAM model of CPUEw by trophic group, survey and gear (Generalised Inverse Gaussian distribution, AIC: -870, df: 9). 

Gear had a highly significant impact on the catch composition, and all tropic groups except planktivores had a significant effect on catches. This is different from the PCA results where planktivores were a very clear factor explaining the variability, but they were caught in just 14 stations.   

Conclusion from PCA and GAM model:  
* Gear significantly affects catch rates  
* Trophic groups (except planktivores) significantly affect catch rates  
* Both Nov surveys (2012 and 2013) had significant effect on catches


***

#### Test differences in CPUE By Species in trap catches, by range of traits and factors
Use GAM model and evaluate how CPUE by weight (CPUEw) was affected by physical / area /surve factors and the traits :
- depth
- survey (random factor)
- area
- family group
- trophic group
- trophic level (linked to trophic group)
- Place in water column
- Diel activity
- Habitat 
- Gregariousness
- MaxLength

```{r GAM CPUEw by all factor, echo=FALSE}
#mod6<-gamlss(CPUEw~depth+factor(id)+factor(gear)+random(factor(survey))+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+factor(FamGroup2),family=ZAGA, data=na.omit(c4)) 
#summary(mod6)

#find best-fitting distribution
ma <- gamlss(CPUEn~depth+factor(id)+random(factor(survey))+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=NO, data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 

t1 <- chooseDist(ma, type="realplus")
getOrder(t1,3)
#cmod1<-update(ma, family=names(getOrder(t1,3)[1]))

# traps only, CPUE by numbers, survey as random factor
mod7<-gamlss(CPUEn~depth+factor(id)+random(factor(survey))+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
#summary(mod7)

# traps only, CPUE by numbers, survey as ordinary factor
mod8 <- gamlss(CPUEn~depth+factor(id)+factor(survey)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
#summary(mod8)

# without areas
mod9 <- gamlss(CPUEn~depth+factor(survey)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 

#without surveys
 mod10 <- gamlss(CPUEn~depth+factor(id)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
 
 #without areas + surveys
 mod11 <-  gamlss(CPUEn~depth+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
 
 # without surveys and depth
 mod12 <- gamlss(CPUEn~factor(id)+TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 
 
 # just traits
 mod13 <- gamlss(CPUEn~TrophicLevel+factor(TGShort)+factor(WaterCol)+factor(DielActivity)+factor(Habitat)+factor(Gregariousness)+MaxLength,family=names(getOrder(t1,3)[1]), data=na.omit(subset(c4, gear=="TB" & CPUEn>0))) 

AIC(mod7, mod8, mod9, mod10, mod11, mod12, mod13)
#mod10 had lowest AIC
summary(mod10)

```
Evaluting catches of fish in relation to their traits. Should be evaluated by numbers, for single large fish not to dominate the results. The model based on CPUE by numbers (mod7, for traps only, CPUE by numbers, survey as random factor) had  the lowest AIC.  Also, including survey as a random factor led to lower AIC than including it as an ordinary factor. 

Model (BCPOe Box-Cox Power Exponential-orig. distribution, AIC: -1410.577, df:24) results show that numbers of fish caught (CPUE by numbers) was significantly affected by:  
* all areas
* all traits, except MaxLength and WaterColumn (demersal)

Interpretation of results: 
If depth was included it was not a significant factor. CPUEn varies significantly by areas and by traits, and with the variability being consistent this indicates regional differences in catches of different trophic groups / traits /species. 
 

```{r histogram max lenght, echo=FALSE}
ggplot(subset(c4, gear=="TB"), aes(MaxLength)) +geom_freqpoly(binwidth = 5)
```



### CPUE by trophic group by area & by survey (year) 
FIG 5 in Feb 2019 version of MS

Presents the CPUE pr hr, for each management area and survey, standardized by the number of traps set in each area X survey combination. 

Trap catches were dominated by carnivores, occuring in all area X survey combinations, followed by invertivores who also occurred everywhere, albeight in lower densities than the carnivores. 

Cathces of planktivores and invertivores varied substantially between areas and surveys, in contrast to carnivores who were caught in all surveys and areas. This explains why invertivores and planktivores were signifant factors on the catches (GAM model of CPUEn with traits), while carnivores were not. 

*Area 2, 5 and 6 seem to have the highest diversity of trophic groups, but this has to be calculated as functional diversity, using the FD package (or similar). *

```{r trophic plot, echo=FALSE}

trophic.plot <- ggplot(subset(catch.traits, TGShort!="NA" & gear=="TB"), aes(TGShort, CPUEw/NArea))

trophic.plot <- trophic.plot + geom_col(aes(fill=TGShort)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Trophic group",values=qualitative_hcl(n = 5, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / (number of traps pr area)") + theme_bw() 
trophic.plot
ggsave("./figs/S2_trophic_group_cpue.png")

tiff(file="./figs/S2_trophic_group_cpue.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
trophic.plot
dev.off()
```


### Trophic group CPUE by depth
A modified version of Figure 6 in Feb 2019 MS. 

Basically a more complex version of the previous plot. Adds the depth dimension to the plot, and the surveys as colours. 

Shows uniform catch rates of carnivores and invertivores from 0-50m. 

All surveys seem to overlap, so no difference in trophich group depth dependent catch rates between the surveys.

```{r trophic depth plot, echo=FALSE}

depth.plot <- ggplot(subset(catch.traits, gear=="TB" & TGShort!="NA"), aes(depth, CPUEw)) 

depth.plot <- depth.plot + geom_point(aes(colour=survey_m))  + facet_grid(vars(id),vars(TGShort)) +  scale_colour_manual(name="Survey",values=qualitative_hcl(n = 3, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x="Depth (m)", y="CPUE (kg(hrs)")  +theme_bw()  

depth.plot

tiff(file="./figs/trophic_group_cpue_depth.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
depth.plot
dev.off()
```


### Trophic level in Trap catches
```{r trophic level, echo=FALSE}

TMean <- subset(catch.traits, gear=="TB" & TrophicLevel!="NA") %>% group_by(id, survey_m) %>% summarise(TM=mean(na.omit(TrophicLevel)))
CMean <- subset(catch.traits, gear=="TB" & TrophicLevel!="NA") %>% group_by(id, survey_m) %>% summarise(CM=mean(CPUEw))
TMean$CM <- CMean$CM

t0.plot <- ggplot(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"), aes(TrophicLevel, CPUEw)) 

t0.plot <- t0.plot + geom_point(aes(colour=TGShort)) + geom_vline(data = TMean, aes(xintercept = TM)) + facet_grid(vars(id),vars(survey_m)) +  scale_colour_manual(name="Trophic group",values=qualitative_hcl(n = 5, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x="Trophic level", y="CPUE (kg(hrs)")  +theme_bw()  
t0.plot

tiff(file="./figs/trophic_level.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t0.plot
dev.off()
```

#### GAM model of trophic level of catches
```{r GAM trophic level, echo=FALSE, warning=FALSE}
tl1 <- gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=NO, data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

t11 <- chooseDist(tl1, type="realplus")
getOrder(t11,3)

names(getOrder(t11,3)[1])

tl1 <- gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=names(getOrder(t11,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

tl2 <- gamlss(TrophicLevel~depth+factor(id)+random(factor(survey)), family=names(getOrder(t11,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

tl3 <- gamlss(TrophicLevel~depth+factor(id)+factor(survey), nu.formula = gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=names(getOrder(t11,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"))), family=names(getOrder(t11,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

tl4 <- gamlss(TrophicLevel~depth+factor(id)+random(factor(survey)), nu.formula = gamlss(TrophicLevel~depth+factor(id)+factor(survey), family=names(getOrder(t11,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"))), family=names(getOrder(t11,3)[1]), data=na.omit(subset(catch.traits, gear=="TB" & TrophicLevel!="NA")))

AIC(tl1, tl2, tl3, tl4)

summary(tl1)

```

The GAM Model (Box-Cox Power Exponential, AIC: 142.3393, df: 19.03) of trophic level by depth, area and surveys only showed area 3 and the intercept to be significant factors affecting the Trophic level of catches meaning that trophic level was similar in all areas except area 3 (and 1)



### Maxlength in catches
```{r maxlength, echo=FALSE}

t0.plot <- ggplot(subset(catch.traits, gear=="TB" & TrophicLevel!="NA"), aes(MaxLength, CPUEn)) 

t0.plot <- t0.plot + geom_point(aes(colour=TGShort)) + facet_grid(vars(id),vars(survey_m)) +  scale_colour_manual(name="Trophic group",values=qualitative_hcl(n = 5, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x="Max lenght(cm)", y="CPUE (no. fish/hour)")  +theme_bw()  
t0.plot
ggsave("./figs/S6_max_length.png")

tiff(file="./figs/S6_max_length.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t0.plot
dev.off()


```


### Place in water column
```{r place in water column, echo=FALSE}

catch.traits$WaterCol[catch.traits$WaterCol=="Demersal"] <- "demersal"
tl.plot <- ggplot(subset(catch.traits, WaterCol!="NA" & gear=="TB"), aes(WaterCol, CPUEw/NArea))

tl.plot <- tl.plot + geom_col(aes(fill=WaterCol)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Place in water column",values=qualitative_hcl(n = 6, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / number of traps pr area") + theme_bw() + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
tl.plot
ggsave("./figs/S3_water_col.png")

tiff(file="./figs/S3_water_col.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
tl.plot
dev.off()
```

### Diel activity
```{r diel activity, echo=FALSE}

t2.plot <- ggplot(subset(catch.traits, DielActivity!="#N/A" & gear=="TB"), aes(DielActivity, CPUEw/NArea))

t2.plot <- t2.plot + geom_col(aes(fill=DielActivity)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Diel activity",values=qualitative_hcl(n = 6, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / number of traps pr area") + theme_bw() + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
t2.plot
ggsave("./figs/S4_diel_act.png")

tiff(file="./figs/S4_diel_act.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t2.plot
dev.off()
```


### Gregariousness
```{r Gregariousness, echo=FALSE}

t3.plot <- ggplot(subset(catch.traits, Gregariousness!="#N/A" & gear=="TB"), aes(Gregariousness, CPUEw/NArea))

t3.plot <- t3.plot + geom_col(aes(fill=Gregariousness)) + facet_grid(vars(id), vars(survey_m)) + scale_fill_manual(name="Gregariousness",values=qualitative_hcl(n = 6, h = c(0, 295), c = 80, l = 60, register = ) ) + labs(x=" ", y="CPUE (kg/hour fishing) / number of traps pr area") + theme_bw() + 
  theme(axis.title.x=element_blank(), axis.text.x=element_blank(), axis.ticks.x=element_blank())
t3.plot

ggsave("./figs/S5_gregariousness.png")

tiff(file="./figs/S5_gregariousness.tiff", width=3000, height=3000, res=400, pointsize=10, compression=c("none"))
t3.plot
dev.off()
```




***
## Biodiversity (species densities, trophic diversity etc)

### Species accumulation curves
```{r species accumulation, echo=FALSE, warning=FALSE}

c41b <- subset(catch.unmod, (depth<=30 & gear=="TB"))
c42b <- subset(catch.unmod, (depth>30 & gear=="TB"))
c411b <- subset (catch.unmod, gear=="GN")
c41b$Drng <- c("<30m")
c411b$Drng <- c("<30m")
c42b$Drng <- c(">30m")

c43b <- rbind(c41b,c411b, c42b)

## TRAPS


### Shallow Traps (<30m)
catch2 <- subset(c43b, (gear=="TB" & species !="NOCATCH" & species != "FISJU09" & Drng=="<30m"))
catch2$Fh_int <- as.integer(catch2$Fhrs)

sp.acc.all <- data.frame(hrs=(min(catch2$Fh_int):max(catch2$Fh_int)), All=0, Area1=0, Area2=0, Area3=0, Area4=0, Area5=0, Area6=0, Area7=0)

for(i in 1:dim(sp.acc.all)[1]) {
  sp.acc.all[i,2] <- subset(catch2, Fh_int<=sp.acc.all[i,1]) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,3] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==1)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,4] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==2)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,5] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==3)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,6] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==4)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,7] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==5)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,8] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==6)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,9] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==7)) %>% dplyr::summarise(n_distinct(species))
}

sp.acc.all.long <- tidyr::gather(sp.acc.all, "area", "n", 2:9)

sp.traps.s <- ggplot(sp.acc.all.long, aes(x=hrs, y=n, group=area)) + geom_step(size=2, aes(colour=area)) + theme_classic() + scale_colour_brewer(palette = "Dark2") + xlab("Hours fishing") + ylab("Number of species") + theme(legend.position = "none") + ggtitle("A: Traps (<30m)")

### Deep Traps (>30m)
catch2 <- subset(c43b, (gear=="TB" & species !="NOCATCH" & species != "FISJU09" & Drng==">30m"))
catch2$Fh_int <- as.integer(catch2$Fhrs)

sp.acc.all <- data.frame(hrs=(min(catch2$Fh_int):max(catch2$Fh_int)), All=0, Area1=0, Area2=0, Area3=0, Area4=0, Area5=0, Area6=0, Area7=0)

for(i in 1:dim(sp.acc.all)[1]) {
  sp.acc.all[i,2] <- subset(catch2, Fh_int<=sp.acc.all[i,1]) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,3] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==1)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,4] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==2)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,5] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==3)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,6] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==4)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,7] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==5)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,8] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==6)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,9] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==7)) %>% dplyr::summarise(n_distinct(species))
}

sp.acc.all.long <- tidyr::gather(sp.acc.all, "area", "n", 2:9)

sp.traps.d <- ggplot(sp.acc.all.long, aes(x=hrs, y=n, group=area)) + geom_step(size=2, aes(colour=area)) + theme_classic() + scale_colour_brewer(palette = "Dark2") + xlab("Hours fishing") + ylab("Number of species") + theme(legend.position = "none") + ggtitle("B: Traps (>30m")





## GILLNETS

catch2 <- subset(c43b, gear=="GN" & species !="NOCATCH" & species != "FISJU09")
catch2$Fh_int <- as.integer(catch2$Fhrs)

sp.acc.all <- data.frame(hrs=(min(catch2$Fh_int):max(catch2$Fh_int)), All=0, Area1=0, Area2=0, Area3=0, Area4=0, Area5=0, Area6=0, Area7=0)

for(i in 1:dim(sp.acc.all)[1]) {
  sp.acc.all[i,2] <- subset(catch2, Fh_int<=sp.acc.all[i,1]) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,3] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==1)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,4] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==2)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,5] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==3)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,6] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==4)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,7] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==5)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,8] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==6)) %>% dplyr::summarise(n_distinct(species))
  sp.acc.all[i,9] <- subset(catch2, (Fh_int<=sp.acc.all[i,1] & id==7)) %>% dplyr::summarise(n_distinct(species))
}

sp.acc.all.long <- tidyr::gather(sp.acc.all, "area", "n", 2:9)

sp.nets <- ggplot(sp.acc.all.long, aes(x=hrs, y=n, group=area)) + geom_step(size=2, aes(colour=area)) + theme_classic() + scale_colour_brewer(palette = "Dark2") + xlab("Hours fishing") + ylab("Number of species") + ggtitle("C: Gillnets")

sp.comb <- sp.traps.s + sp.traps.d + sp.nets
sp.comb

ggsave("./figs/Fig 5 species_accumulation.png")
ggsave("./figs/Fig 5 species_accumulation.tiff")
```



*** 

### Functional diversity
UPDATE March 2021. Including both traps and gillnet data in analysis.  

We did not split the FD analysis by depth (<> 30m) as this would bias the shallow bin because that would include both gillnets and traps while the deep bin only included trap catches. 

We used the same approach as Stuart-Smith et al. to exclude very few observations of a single species and excluded all species observations occuring in 2 or fewer stations (traps). 

To avoid dbFD crashing 'm' was set in the 'dbFD' call (the number of PoCA  axes kept as traits to do the FRic analysis). Several levels of 'm' were tested, and this could probably be tested further (to higher levels of 'm')

##### Results for n_spec > 2 m=10
Results based on the output from the dbFD analysis:

Overall Fric (R2)=  0.533 (compared to 0.62 for traps only data)


```{r functional diversity, echo=FALSE, warning=FALSE}

#ss_list <- levels(catch1$survey)
#sp_occur <- subset(catch1, CPUEn>0 & gear=="TB")  %>% dplyr::group_by(Sci_name) %>% dplyr::summarise(n())
sp_occur <- subset(catch1, CPUEn>0 & gear=="TB" | gear=="GN")  %>% dplyr::group_by(Sci_name) %>% dplyr::summarise(n())
colnames(sp_occur) <- c("Sci_name", "n_spec")

# wrangle traits into a traitstable that can be used in FD
missing <- setdiff( x=traits$x1, y=subset(sp_occur, n_spec>2)$Sci_name)
t5 <- traits[!traits$x1 %in% missing,]
#t5 <- traits[traits$x1 %in% subset(sp_occur, n_spec>2)$Sci_name,]
tr <- t5[,c(4:10)]
rownames(tr) <- t5$x1
tr[(tr=="#N/A")] <- c(NA)
tr <- droplevels(tr)
tr$diel<-as.integer(as.factor(tr$Diel.Activity))
tr$diel[(tr$diel==2)] <- c(0)
tr <- tr[,c(1,2,3,4,6,7,8)]
#convert character variables to factors
tr$Trophic.group <- as.factor(tr$Trophic.group)
tr$Water.column <- as.factor(tr$Water.column)
tr$Habitat <- as.factor(tr$Habitat)
tr$Gregariousness <- as.factor(tr$Gregariousness)



# wrangle 'catch1' to aggregate CPUE pr area (row) pr species (columns)
missing <- setdiff( x=catch1$Sci_name, y=rownames(tr))
c5 <- catch1[!catch1$Sci_name %in% missing,]
#c_melt <- melt(c5[,c(28,11,22)], id=c("id", "Sci_name")) # weight by CPUEw
#c_melt <- melt(c5[,c(28,11,23)], id=c("id", "Sci_name")) # weight by CPUEn
c_melt <- melt(c5[,c(30,6,25)], id=c("id", "Sci_name")) # weight by CPUEn

#convert abundance to integer for better calculation performance
med_int1000 <- function(x) as.integer(median(x)*1000)
abund <- dcast(c_melt, id ~ Sci_name, value.var="value", fun=med_int1000) 
# to calculate with raw abundance data, use line below:
#abund <- dcast(c_melt, id ~ Sci_name, value.var="value", fun=median)
abund[is.na(abund)] <- 0
abund <- abund[,c(2:length(abund))]

#calculate FD using dbFD function, m set to 10 to avoid crach (int overload in QHULL)
FuncDiv <- dbFD(tr, abund, corr = c("lingoes"), m=10)

FDt <- as.data.frame(rbind(FuncDiv$FEve, FuncDiv$FDiv, FuncDiv$FDis, FuncDiv$RaoQ))
rownames(FDt) <- c("FEve", "FDiv", "FDis", "RaoQ")
colnames(FDt) <- c("A1", "A2", "A3", "A4", "A5", "A6", "A7")

FDt <- as.data.frame(t(round(FDt, digits=3)))

# Nice-looking table using 'kable', highlighting highest values in red
FDt %>%
  dplyr::mutate(
    Area = cell_spec(row.names(.), color = "black"),
    FEve = cell_spec(FEve, "html", color = ifelse(FEve >= max(FEve), "red", "black")),
    FDiv = cell_spec(FDiv, "html", color = ifelse(FDiv >= max(FDiv), "red", "black")),
    FDis = cell_spec(FDis, "html", color = ifelse(FDis >= max(FDis), "red", "black")),
    RaoQ = cell_spec(RaoQ, "html", color = ifelse(RaoQ >= max(RaoQ), "red", "black"))
  ) %>%
  dplyr::select(Area, FEve, FDiv, FDis, RaoQ) %>%
  kable(format = "html", escape = F) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
```

#### Rerunning the FD model excluding one trait at a time
Need to reduce 'm' to 9 to avoid crash:

*Zero distance(s)Error in convhulln(tr.FRic, "FA") :* 
  *Received error code 2 from qhull. Qhull error:*
    *QH6114 qhull precision error: initial simplex is not convex. Distance=1.4e-16* 
    
Removing traits only improved the R2 by max 9.6% (by removing Maxlength). Therefore decided to keep all the traits in the model for Traps and Gillnets
  
```{r FD model excluding traits, echo=FALSE, warning=FALSE}
# create data frame with original RaoQ and FRic
Raoq <- as.data.frame(c(FuncDiv$RaoQ, FuncDiv$qual.FRic))
colnames(Raoq) <- c("All")
rownames(Raoq) <- c("A1", "A2", "A3", "A4", "A5", "A6", "A7", "R2")


# select tr, but excluding one variable at a time
#tr[,c(1,!2,3,4,5,6,7)]
for (i in 1:7) { 
  FDout <- dbFD(tr[,c(setdiff(1:7, i))], abund, corr = c("lingoes"), m=10)
  raoq1 <- as.data.frame(c(FDout$RaoQ, FDout$qual.FRic))
  colnames(raoq1) <- colnames(tr)[i]
  Raoq <- cbind(Raoq, raoq1)
}

#model excluding MaxLength
FDout1 <- dbFD(tr[,c(2:7)], abund, corr = c("lingoes"), m=10)
raoq11 <- as.data.frame(c(FDout1$RaoQ, FDout1$qual.FRic))
colnames(raoq11) <- c("exl_ML")
Raoq <- cbind(Raoq, raoq11)

#r2 for all models
formattable(round(Raoq[8,], digits=3))

#R2 per area and model
formattable(round(Raoq[c(1:7),], digits=3), list(    MaxLength = color_tile("transparent", "lightpink"),     Trophic.Level = color_tile("transparent", "lightpink"),     Trophic.group = color_tile("transparent", "lightpink"),    Water.column = color_tile("transparent", "lightpink"), Habitat = color_tile("transparent", "lightpink"),    Gregariousness = color_tile("transparent", "lightpink"), diel = color_tile("transparent", "lightpink"), ML_TL= color_tile("transparent", "lightpink")))

write.csv2(Raoq, "./figs/Raoq_table.csv")

```


***
## Results table
This table combines CPUE, traits pr gear type, species density and RaoQ into one results-table. 

```{r results table, echo=FALSE}

st2 <- catch %>% dplyr::group_by(ss) %>% dplyr::summarise(first(id), first(Fhrs), first(gear), sum(weight), sum(number))
colnames(st2) <- c("ss", "id", "Fhrs","gear", "weight","number")
st2$CPUEw <- st2$weight/st2$Fhrs
st2$CPUEn <- st2$number/st2$Fhrs

results.table <- data.frame(area=(1:7))
results.table <- cbind(results.table,(subset(st2, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEw)))[,2])
results.table <- cbind(results.table,(subset(st2, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEw)))[,2])
results.table <- cbind(results.table,(subset(st2, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEn)))[,2])
results.table <- cbind(results.table,(subset(st2, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(CPUEn)))[,2])
results.table <- cbind(results.table,(subset(catch.traits, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(TrophicLevel, na.rm = TRUE)))[,2])
results.table <- cbind(results.table,(subset(catch.traits, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(TrophicLevel, na.rm = TRUE)))[,2])
results.table<- cbind(results.table,(subset(catch.traits, gear=="TB") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(as.integer(Gregariousness), na.rm = TRUE)))[,2])
results.table<- cbind(results.table,(subset(catch.traits, gear=="GN") %>% dplyr::group_by(id) %>% dplyr::summarise( mean(as.integer(Gregariousness), na.rm = TRUE)))[,2])
colnames(results.table) <- c("area", "TrapCPUEw", "GillnetCPUEw", "TrapCPUEn", "GillnetCPUEn", "TrophicL_Traps", "TrophicL_Gillnets", "Greg_Traps", "Greg_Gillnets" )

TMean <- subset(catch.traits, gear=="TB" & TrophicLevel!="NA") %>% dplyr::group_by(id, survey_m) %>% dplyr::summarise(TM=mean(na.omit(TrophicLevel)))

#results.table$SpeciesDensity <- sp.area.comb$Average
#results.table$RaoQ <- Raoq$ML_TL[1:7]
results.table$RaoQ <- Raoq$All[1:7]

# formattable(round(results.table, digits = 3))

write.csv2(round(results.table, digits = 3), "./figs/results_table.csv")

results.table %>%
  kable(format = "html", escape = F, digits = 3) %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))
  

```

